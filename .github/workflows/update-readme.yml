---
name: Update README

'on':
  push:
    branches:
      - main
    paths:
      - Casks/*.rb
  pull_request:
    branches:
      - main
    paths:
      - Casks/*.rb
  workflow_dispatch: {}
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 02:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 10:00ï¼‰
    - cron: 0 2 * * *

# é˜²æ­¢å¹¶å‘æ‰§è¡Œ
concurrency:
  group: update-readme
  cancel-in-progress: true

jobs:
  update-readme:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: è®¾ç½® Git é…ç½®
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: ç”Ÿæˆ Casks åˆ—è¡¨å¹¶æ›´æ–° README
        run: |
          echo "ğŸ“ æ­£åœ¨ç”Ÿæˆ Casks åˆ—è¡¨..."

          # åˆ›å»ºä¸´æ—¶æ–‡ä»¶å­˜å‚¨åº”ç”¨ç¨‹åºè¡¨æ ¼å†…å®¹
          temp_table="/tmp/app_table.md"

          # ç”Ÿæˆè¡¨æ ¼å¤´éƒ¨
          cat > "$temp_table" << 'EOF'
          | åº”ç”¨åç§° | æè¿° | ç‰ˆæœ¬ | å®‰è£…å‘½ä»¤ | ä¸»é¡µ |
          |---------|------|------|----------|------|
          EOF

          # éå†æ‰€æœ‰ Cask æ–‡ä»¶å¹¶æå–ä¿¡æ¯
          for cask_file in Casks/*.rb; do
            if [ -f "$cask_file" ]; then
              # æå– Cask åç§°ï¼ˆæ–‡ä»¶åå»æ‰ .rb æ‰©å±•åï¼‰
              cask_name=$(basename "$cask_file" .rb)

              # æå–åº”ç”¨ç¨‹åºæ˜¾ç¤ºåç§°
              display_name=$(grep -E '^[[:space:]]*name[[:space:]]+".*"' "$cask_file" |
                sed -E 's/^[[:space:]]*name[[:space:]]+"(.*)".*$/\1/' | head -1)
              if [ -z "$display_name" ]; then
                display_name="$cask_name"
              fi

              # æå–æè¿°
              description=$(grep -E '^[[:space:]]*desc[[:space:]]+".*"' "$cask_file" |
                sed -E 's/^[[:space:]]*desc[[:space:]]+"(.*)".*$/\1/' | head -1)
              if [ -z "$description" ]; then
                description="-"
              fi

              # æå–ç‰ˆæœ¬
              version=$(grep -E '^[[:space:]]*version[[:space:]]+".*"' "$cask_file" |
                sed -E 's/^[[:space:]]*version[[:space:]]+"(.*)".*$/\1/' | head -1)
              if [ -z "$version" ]; then
                version="-"
              fi

              # æå–ä¸»é¡µ
              homepage=$(grep -E '^[[:space:]]*homepage[[:space:]]+".*"' "$cask_file" |
                sed -E 's/^[[:space:]]*homepage[[:space:]]+"(.*)".*$/\1/' | head -1)
              if [ -z "$homepage" ]; then
                homepage="-"
              else
                homepage="[ğŸ”—]($homepage)"
              fi

              # ç”Ÿæˆå®‰è£…å‘½ä»¤
              install_command="\`brew install gandli/proxy/$cask_name\`"

              # æ·»åŠ åˆ°è¡¨æ ¼ä¸­
              echo "| **$display_name** | $description | \`$version\` | $install_command | $homepage |" >> "$temp_table"
            fi
          done

          # å¤‡ä»½åŸå§‹ README.md
          cp README.md README.md.backup

          # ä½¿ç”¨ awk æ›¿æ¢åº”ç”¨ç¨‹åºè¡¨æ ¼éƒ¨åˆ†
          # æŸ¥æ‰¾ "## ğŸ“¦ åº”ç”¨ç¨‹åº" åˆ°ä¸‹ä¸€ä¸ª "##" ä¹‹é—´çš„å†…å®¹å¹¶æ›¿æ¢
          awk '
          BEGIN { in_apps_section = 0; table_replaced = 0 }
          /^## ğŸ“¦ åº”ç”¨ç¨‹åº/ {
            print $0
            print ""
            # è¯»å–å¹¶æ’å…¥æ–°çš„è¡¨æ ¼å†…å®¹
            while ((getline line < "/tmp/app_table.md") > 0) {
              print line
            }
            close("/tmp/app_table.md")
            in_apps_section = 1
            table_replaced = 1
            next
          }
          /^## / && in_apps_section && table_replaced {
            in_apps_section = 0
            print ""
            print $0
            next
          }
          !in_apps_section || !table_replaced {
            print $0
          }
          ' README.md.backup > README.md

          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f "$temp_table" README.md.backup

          echo "âœ… README.md åº”ç”¨ç¨‹åºéƒ¨åˆ†å·²æ›´æ–°"

      - name: æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
        id: check_changes
        run: |
          if git diff --quiet README.md; then
            echo "ğŸ“‹ README.md æ²¡æœ‰å˜æ›´"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“ æ£€æµ‹åˆ° README.md å˜æ›´"
            echo "has_changes=true" >> $GITHUB_OUTPUT

            echo "å˜æ›´å†…å®¹ï¼š"
            git diff README.md
          fi

      - name: æäº¤å˜æ›´
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git add README.md
          git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–° README.md ä¸­çš„ Casks åˆ—è¡¨

          - æ›´æ–°åº”ç”¨ç¨‹åºåˆ—è¡¨
          - åŒæ­¥ç‰ˆæœ¬ä¿¡æ¯
          - æ›´æ–°æè¿°å’Œé“¾æ¥

          ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ"

          echo "âœ… å˜æ›´å·²æäº¤"

      - name: æ¨é€å˜æ›´
        if: steps.check_changes.outputs.has_changes == 'true' && github.event_name != 'pull_request'
        run: |
          git push origin main
          echo "ğŸš€ å˜æ›´å·²æ¨é€åˆ°ä¸»åˆ†æ”¯"

      - name: åˆ›å»º Pull Requestï¼ˆå¦‚æœæ˜¯ PR è§¦å‘ï¼‰
        if: steps.check_changes.outputs.has_changes == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { data: pullRequest } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸ¤– **è‡ªåŠ¨æ›´æ–°æé†’**\n\næ£€æµ‹åˆ° Casks æ–‡ä»¶å˜æ›´ï¼Œ' +
                'README.md å·²è‡ªåŠ¨æ›´æ–°ä»¥åæ˜ æœ€æ–°çš„åº”ç”¨ç¨‹åºåˆ—è¡¨ã€‚\n\nğŸ“ å˜æ›´å†…å®¹ï¼š\n' +
                '- æ›´æ–°åº”ç”¨ç¨‹åºåˆ—è¡¨\n- åŒæ­¥ç‰ˆæœ¬ä¿¡æ¯\n- æ›´æ–°æè¿°å’Œé“¾æ¥\n\n' +
                'âœ… è¯·æ£€æŸ¥æ›´æ–°åçš„ README.md æ–‡ä»¶ã€‚'
            });

      - name: è¾“å‡ºæ€»ç»“
        run: |
          echo "ğŸ“Š å·¥ä½œæµæ‰§è¡Œæ€»ç»“ï¼š"
          echo "- è§¦å‘äº‹ä»¶: ${{ github.event_name }}"
          echo "- åˆ†æ”¯: ${{ github.ref_name }}"
          echo "- æ˜¯å¦æœ‰å˜æ›´: ${{ steps.check_changes.outputs.has_changes }}"

          if [ "${{ steps.check_changes.outputs.has_changes }}" = "true" ]; then
            echo "âœ… README.md å·²æˆåŠŸæ›´æ–°"
          else
            echo "â„¹ï¸ README.md æ— éœ€æ›´æ–°"
          fi
