---
name: Validate Casks

"on":
  push:
    branches: [main]
    paths:
      - Casks/**
  pull_request:
    branches: [main]
    paths:
      - Casks/**
  workflow_dispatch: {}
  schedule:
    # æ¯å‘¨ä¸€æ—©ä¸Š 8 ç‚¹è¿è¡Œä¸€æ¬¡å®Œæ•´éªŒè¯
    - cron: 0 8 * * 1

env:
  HOMEBREW_NO_ANALYTICS: 1
  HOMEBREW_NO_AUTO_UPDATE: 1
  HOMEBREW_NO_INSECURE_REDIRECT: 1
  HOMEBREW_NO_INSTALL_CLEANUP: 1

jobs:
  validate:
    name: Validate Cask Standards
    runs-on: macos-latest
    timeout-minutes: 30

    # é˜²æ­¢å¹¶å‘è¿è¡Œ
    concurrency:
      group: validate-casks-${{ github.ref }}
      cancel-in-progress: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cache Homebrew
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Caches/Homebrew
            /opt/homebrew/var/homebrew/locks
            /opt/homebrew/Library/Taps
          key: homebrew-${{ runner.os }}-${{ hashFiles('Casks/**') }}
          restore-keys: |
            homebrew-${{ runner.os }}-

      - name: Set up Homebrew
        id: set-up-homebrew
        uses: Homebrew/actions/setup-homebrew@master

      - name: Install dependencies
        run: |
          # ç¡®ä¿è„šæœ¬æœ‰æ‰§è¡Œæƒé™
          chmod +x .github/scripts/validate-casks.sh

      - name: Run Cask validation
        id: validate
        run: |
          echo "::group::Cask Validation Results"
          ./.github/scripts/validate-casks.sh
          echo "::endgroup::"
        continue-on-error: true

      - name: Check for changed Casks (PR only)
        if: github.event_name == 'pull_request'
        id: changed-casks
        run: |
          # è·å–å˜æ›´çš„ Cask æ–‡ä»¶
          CHANGED_CASKS=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '^Casks/.*\.rb$' || true)

          if [[ -n "$CHANGED_CASKS" ]]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "files<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGED_CASKS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT

            echo "::group::Changed Cask Files"
            echo "$CHANGED_CASKS"
            echo "::endgroup::"
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Validate changed Casks only (PR)
        if: github.event_name == 'pull_request' && steps.changed-casks.outputs.changed == 'true'
        run: |
          echo "::group::Validating Changed Casks"

          # ä¸ºæ¯ä¸ªå˜æ›´çš„ Cask è¿è¡Œè¯¦ç»†éªŒè¯
          while IFS= read -r cask_file; do
            if [[ -f "$cask_file" ]]; then
              echo "\n=== è¯¦ç»†éªŒè¯: $cask_file ==="

              # è¿è¡Œ brew audit
              if command -v brew >/dev/null 2>&1; then
                echo "Running brew audit for $cask_file..."
                brew audit --cask "$cask_file" || true
              fi

              # æ£€æŸ¥è¯­æ³•
              echo "Checking Ruby syntax for $cask_file..."
              ruby -c "$cask_file" || true

              # è¿è¡Œè‡ªå®šä¹‰éªŒè¯
              echo "Running custom validation for $cask_file..."
              ./.github/scripts/validate-casks.sh "$cask_file" || true
            fi
          done <<< "${{ steps.changed-casks.outputs.files }}"

          echo "::endgroup::"

      - name: Generate validation summary
        if: always()
        run: |
          echo "::group::Validation Summary"

          if [[ "${{ steps.validate.outcome }}" == "success" ]]; then
            echo "âœ… æ‰€æœ‰ Cask æ–‡ä»¶éªŒè¯é€šè¿‡"
            echo "VALIDATION_STATUS=success" >> $GITHUB_ENV
          else
            echo "âŒ Cask æ–‡ä»¶éªŒè¯å¤±è´¥"
            echo "VALIDATION_STATUS=failure" >> $GITHUB_ENV
          fi

          # ç»Ÿè®¡ä¿¡æ¯
          TOTAL_CASKS=$(find Casks -name "*.rb" | wc -l | tr -d ' ')
          echo "ğŸ“Š æ€» Cask æ•°é‡: $TOTAL_CASKS"

          # æ£€æŸ¥ livecheck è¦†ç›–ç‡
          CASKS_WITH_LIVECHECK=$(grep -l "livecheck do" Casks/*.rb | wc -l | tr -d ' ')
          LIVECHECK_COVERAGE=$((CASKS_WITH_LIVECHECK * 100 / TOTAL_CASKS))
          echo "ğŸ“ˆ Livecheck è¦†ç›–ç‡: ${LIVECHECK_COVERAGE}% ($CASKS_WITH_LIVECHECK/$TOTAL_CASKS)"

          # æ£€æŸ¥å¤šæ¶æ„æ”¯æŒ
          MULTI_ARCH_CASKS=$(grep -l "arch arm:" Casks/*.rb | wc -l | tr -d ' ')
          MULTI_ARCH_COVERAGE=$((MULTI_ARCH_CASKS * 100 / TOTAL_CASKS))
          echo "ğŸ—ï¸ å¤šæ¶æ„æ”¯æŒ: ${MULTI_ARCH_COVERAGE}% ($MULTI_ARCH_CASKS/$TOTAL_CASKS)"

          echo "::endgroup::"

      - name: Comment PR (if validation fails)
        if: github.event_name == 'pull_request' && env.VALIDATION_STATUS == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            // æ£€æŸ¥æ˜¯å¦å·²æœ‰éªŒè¯å¤±è´¥çš„è¯„è®º
            const existingComment = comments.find(comment =>
              comment.user.login === 'github-actions[bot]' &&
              comment.body.includes('âŒ Cask éªŒè¯å¤±è´¥')
            );

            const body = `âŒ **Cask éªŒè¯å¤±è´¥**

            æ‚¨çš„ PR ä¸­çš„ Cask æ–‡ä»¶æœªé€šè¿‡æ ‡å‡†åŒ–éªŒè¯ã€‚è¯·æ£€æŸ¥ä»¥ä¸‹å†…å®¹ï¼š

            - âœ… ç¡®ä¿æ‰€æœ‰å¿…éœ€å­—æ®µéƒ½å·²å¡«å†™
            - âœ… æ·»åŠ  \`livecheck\` é…ç½®ï¼ˆæ¨èä½¿ç”¨ \`github_latest\` ç­–ç•¥ï¼‰
            - âœ… æ£€æŸ¥æ¶æ„æ”¯æŒå’Œå‘½åè§„èŒƒ
            - âœ… ç¡®ä¿ URL ä½¿ç”¨ HTTPS
            - âœ… è¿è¡Œ \`brew audit --cask <cask-file>\` æ£€æŸ¥

            è¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹ [éªŒè¯æ—¥å¿—](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})ã€‚

            ğŸ“– å‚è€ƒæ–‡æ¡£ï¼š[Cask æ ‡å‡†åŒ–æŒ‡å—](.github/CASK_STANDARDS.md)`;

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }

      - name: Comment PR (if validation succeeds)
        if: github.event_name == 'pull_request' && env.VALIDATION_STATUS == 'success'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            // åˆ é™¤ä¹‹å‰çš„éªŒè¯å¤±è´¥è¯„è®º
            const failureComment = comments.find(comment =>
              comment.user.login === 'github-actions[bot]' &&
              comment.body.includes('âŒ Cask éªŒè¯å¤±è´¥')
            );

            if (failureComment) {
              await github.rest.issues.deleteComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: failureComment.id
              });
            }

            // æ·»åŠ æˆåŠŸè¯„è®º
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `âœ… **Cask éªŒè¯é€šè¿‡**\n\næ‚¨çš„ PR ä¸­çš„æ‰€æœ‰ Cask æ–‡ä»¶éƒ½ç¬¦åˆé¡¹ç›®æ ‡å‡†åŒ–è¦æ±‚ã€‚æ„Ÿè°¢æ‚¨çš„è´¡çŒ®ï¼ ğŸ‰`
            });

      - name: Fail job if validation failed
        if: env.VALIDATION_STATUS == 'failure'
        run: |
          echo "âŒ Cask éªŒè¯å¤±è´¥ï¼Œè¯·ä¿®å¤ä¸Šè¿°é—®é¢˜åé‡æ–°æäº¤"
          exit 1
