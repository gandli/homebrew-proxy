---
name: Update Casks

"on":
  schedule:
    - cron: 0 2 * * *
  workflow_dispatch: {}
  push:
    paths:
      - 'Casks/*.rb'
    branches:
      - main

# é˜²æ­¢å¹¶å‘æ‰§è¡Œï¼Œé¿å…APIé€Ÿç‡é™åˆ¶å†²çª
concurrency:
  group: update-casks
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # è®¾ç½®è¶…æ—¶æ—¶é—´
    # é¿å…å¾ªç¯è§¦å‘ï¼šæ’é™¤ç”± GitHub Actions è‡ªåŠ¨æäº¤çš„æ¨é€
    if: github.actor != 'github-actions[bot]'
    steps:
      - uses: actions/checkout@v4

      # ç¼“å­˜Rubyä¾èµ–
      - name: Cache Ruby dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gem
            vendor/bundle
          key: ${{ runner.os }}-ruby-3.0-${{ hashFiles('**/Gemfile.lock', '**/gems.locked') }}
          restore-keys: |
            ${{ runner.os }}-ruby-3.0-
            ${{ runner.os }}-ruby-

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.0'
          bundler-cache: true  # è‡ªåŠ¨ç¼“å­˜bundlerä¾èµ–

      - name: Update all casks
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          # æ™ºèƒ½èµ„æºæ–‡ä»¶åŒ¹é…å‡½æ•°
          find_matching_asset() {
            local latest_release="$1"
            local base_name="$2"
            local file_ext="$3"
            
            echo "ğŸ” å¼€å§‹æ™ºèƒ½å¤šè½®å›é€€åŒ¹é…ç­–ç•¥..." >&2
            
            # æå–åº”ç”¨åç§°ï¼ˆå»é™¤è¿å­—ç¬¦ï¼Œè½¬æ¢ä¸ºç‚¹åˆ†éš”ï¼‰
            local app_name
            app_name=$(echo "$base_name" | sed -E 's/-([a-z])/\U\1/g' | sed -E 's/^([a-z])/\U\1/')
            
            # è·å–å½“å‰æ¶æ„
            local current_arch="aarch64"  # GitHub Actions é»˜è®¤ä¸º x64ï¼Œä½†æˆ‘ä»¬ä¼˜å…ˆåŒ¹é… Apple Silicon
            
            # æ„å»ºå¤šç§æœç´¢ç­–ç•¥
            local strategies=(
              # ç­–ç•¥1ï¼šåŸºäºåº”ç”¨åç§°çš„ç²¾ç¡®åŒ¹é…
              "cask_original:$base_name"
              # ç­–ç•¥2ï¼šåŸºäºåº”ç”¨åç§°çš„ç‚¹åˆ†éš”åŒ¹é…
              "cask_dots:$(echo "$base_name" | sed 's/-/\./g')"
              # ç­–ç•¥3ï¼šéƒ¨åˆ†åç§°åŒ¹é…ï¼ˆå»é™¤å¸¸è§åç¼€ï¼‰
              "partial_dots:$(echo "$base_name" | sed -E 's/-(rev|party|meta|pro|plus)$//' | sed 's/-/\./g')"
              # ç­–ç•¥4ï¼šåº”ç”¨åç§°åŒ¹é…
              "app_name:$app_name"
              # ç­–ç•¥5ï¼šæ¶æ„ç‰¹å®šåŒ¹é…
              "arch_specific:$current_arch"
            )
            
            # å¤šè½®åŒ¹é…æ‰§è¡Œ
            for strategy in "${strategies[@]}"; do
              local strategy_type="${strategy%%:*}"
              local search_term="${strategy#*:}"
              
              echo "ğŸ¯ å°è¯•ç­–ç•¥: $strategy_type -> $search_term" >&2
              
              local download_url=""
              
              case "$strategy_type" in
                 "cask_original")
                    # ä¼˜å…ˆåŒ¹é…å½“å‰æ¶æ„ï¼ˆå¤§å°å†™ä¸æ•æ„Ÿï¼‰
                    download_url=$(echo "$latest_release" | \
                      jq -r --arg term "$search_term" --arg arch "$current_arch" --arg ext "$file_ext" \
                        '.assets[] | select(.name | test(".*" + $term + ".*_" + $arch + "\\." + $ext; "i")) | .browser_download_url' | head -1)
                    if [[ -z "$download_url" || "$download_url" == "null" ]]; then
                      # é€šç”¨åŒ¹é…ï¼ˆå¤§å°å†™ä¸æ•æ„Ÿï¼‰
                      download_url=$(echo "$latest_release" | \
                        jq -r --arg term "$search_term" --arg ext "$file_ext" \
                          '.assets[] | select(.name | test(".*" + $term + ".*\\." + $ext; "i")) | .browser_download_url' | head -1)
                    fi
                    ;;
                  "cask_dots"|"partial_dots")
                    # ä¼˜å…ˆåŒ¹é…å½“å‰æ¶æ„ï¼ˆå¤§å°å†™ä¸æ•æ„Ÿï¼‰
                    download_url=$(echo "$latest_release" | \
                      jq -r --arg term "$search_term" --arg arch "$current_arch" --arg ext "$file_ext" \
                        '.assets[] | select(.name | test(".*" + $term + ".*_" + $arch + "\\." + $ext; "i")) | .browser_download_url' | head -1)
                    if [[ -z "$download_url" || "$download_url" == "null" ]]; then
                      # é€šç”¨åŒ¹é…ï¼ˆå¤§å°å†™ä¸æ•æ„Ÿï¼‰
                      download_url=$(echo "$latest_release" | \
                        jq -r --arg term "$search_term" --arg ext "$file_ext" \
                          '.assets[] | select(.name | test(".*" + $term + ".*\\." + $ext; "i")) | .browser_download_url' | head -1)
                    fi
                    ;;
                  "app_name")
                    # åº”ç”¨åç§°åŒ¹é…ï¼ˆå¤§å°å†™ä¸æ•æ„Ÿï¼‰
                    download_url=$(echo "$latest_release" | \
                      jq -r --arg term "$search_term" --arg ext "$file_ext" \
                        '.assets[] | select(.name | test(".*" + $term + ".*\\." + $ext; "i")) | .browser_download_url' | head -1)
                    ;;
                  "arch_specific")
                    # æ¶æ„ç‰¹å®šåŒ¹é…ï¼ˆå¤§å°å†™ä¸æ•æ„Ÿï¼‰
                    download_url=$(echo "$latest_release" | \
                      jq -r --arg term "$search_term" --arg ext "$file_ext" \
                        '.assets[] | select(.name | test(".*_" + $term + "\\." + $ext; "i")) | .browser_download_url' | head -1)
                    ;;
              esac
              
              if [[ -n "$download_url" && "$download_url" != "null" ]]; then
                local matched_file
                matched_file=$(echo "$latest_release" | \
                  jq -r ".assets[] | select(.browser_download_url == \"$download_url\") | .name")
                echo "âœ… ç­–ç•¥ $strategy_type æˆåŠŸåŒ¹é…: $matched_file" >&2
                echo "$download_url"
                return 0
              fi
            done
            
            echo "âŒ æ‰€æœ‰æ™ºèƒ½åŒ¹é…ç­–ç•¥éƒ½å¤±è´¥äº†" >&2
            return 1
          }

          # ä» cask æ–‡ä»¶ä¸­æå– GitHub ä»“åº“ä¿¡æ¯çš„å‡½æ•°
          extract_repo_info() {
            local cask_file="$1"

            # æå– homepage URL (GitHub ä»“åº“)
            local homepage
            homepage=$(grep -E '^\s*homepage\s+"' "$cask_file" | sed -E 's/.*homepage\s+"([^"]+)".*/\1/')

            # å¦‚æœ homepage ä¸æ˜¯ GitHubï¼Œå°è¯•ä» URL ä¸­æå–
            if [[ "$homepage" != *"github.com"* ]]; then
              homepage=$(grep -E '^\s*url\s+"' "$cask_file" | \
                sed -E 's/.*"https:\/\/github\.com\/([^\/]+\/[^\/]+)\/.*/https:\/\/github.com\/\1/' | head -1)
            fi

            # æå– URL æ¨¡å¼æ¥æ¨æ–­èµ„æºæ–‡ä»¶å
            local url_line
            url_line=$(grep -E '^\s*url\s+"' "$cask_file" | head -1)
            local asset_pattern=""

            # é€šç”¨çš„èµ„æºæ–‡ä»¶åæ¨æ–­é€»è¾‘
            # ä» URL ä¸­æå–æ–‡ä»¶åæ¨¡å¼ï¼Œæ”¯æŒç‰ˆæœ¬å’Œæ¶æ„å˜é‡æ›¿æ¢
            if [[ "$url_line" =~ url[[:space:]]+\"([^\"]+)\" ]]; then
              local url_template
              url_template="${BASH_REMATCH[1]}"

              # æå–æ–‡ä»¶åéƒ¨åˆ†ï¼ˆæœ€åä¸€ä¸ª / ä¹‹åçš„å†…å®¹ï¼‰
              local filename
              filename=$(echo "$url_template" | sed -E 's/.*\///')

              echo "ğŸ“‹ æå–çš„æ–‡ä»¶åæ¨¡æ¿: $filename" >&2

              # å¤„ç†ä¸åŒçš„æ–‡ä»¶åæ¨¡å¼
              if [[ "$filename" == *"#{"* ]]; then
                # åŒ…å«å˜é‡çš„æƒ…å†µï¼Œæ›¿æ¢ä¸ºé€šç”¨æ¨¡å¼
                asset_pattern="$filename"

                # æ›¿æ¢ç‰ˆæœ¬å˜é‡
                asset_pattern=$(echo "$asset_pattern" | sed -E 's/#\{version\}/[0-9]+\.[0-9]+\.[0-9]+/g')

                # å¤„ç†æ¶æ„å˜é‡
                if [[ "$asset_pattern" == *"#{arch}"* ]]; then
                  # å¯¹äºæœ‰æ¶æ„å˜é‡çš„æƒ…å†µï¼Œåˆ›å»ºä¸€ä¸ªæ›´å®½æ³›çš„æ¨¡å¼
                  asset_pattern=$(echo "$asset_pattern" | \
                    sed -E 's/#\{arch\}/(aarch64|arm64|x64|x86_64)/g')
                elif [[ "$asset_pattern" == *"_aarch64"* || "$asset_pattern" == *"_x64"* ]]; then
                  # å¤„ç†å›ºå®šæ¶æ„çš„æƒ…å†µ
                  asset_pattern=$(echo "$asset_pattern" | \
                    sed -E 's/_(aarch64|x64)/_(aarch64|arm64|x64|x86_64)/g')
                fi

                # è½¬ä¹‰æ­£åˆ™è¡¨è¾¾å¼ç‰¹æ®Šå­—ç¬¦
                asset_pattern=$(echo "$asset_pattern" | sed -E 's/\./\\./g')

                # è°ƒè¯•è¾“å‡ºï¼šæ˜¾ç¤ºå®Œæ•´çš„æ¨¡å¼ç”Ÿæˆè¿‡ç¨‹
                echo "ğŸ”§ åŸå§‹æ–‡ä»¶å: $filename" >&2
                echo "ğŸ”§ å¤„ç†åçš„æ¨¡å¼: $asset_pattern" >&2
                echo "ğŸ”§ æ¨¡å¼é•¿åº¦: ${#asset_pattern}" >&2
              else
                # å›ºå®šæ–‡ä»¶åçš„æƒ…å†µï¼ˆå¦‚ Hiddify-MacOS.dmgï¼‰
                asset_pattern=$(echo "$filename" | sed -E 's/\./\\./g')
              fi

              echo "ğŸ¯ ç”Ÿæˆçš„èµ„äº§æ¨¡å¼: $asset_pattern" >&2

              # æ£€æŸ¥æ¨¡å¼é•¿åº¦ï¼Œé˜²æ­¢æˆªæ–­
              if [[ ${#asset_pattern} -lt 10 ]]; then
                echo "âš ï¸  èµ„äº§æ¨¡å¼ä¼¼ä¹å¤ªçŸ­ï¼Œå¯èƒ½è¢«æˆªæ–­: '$asset_pattern'" >&2
              fi
            else
              echo "âš ï¸  æ— æ³•ä»ä»¥ä¸‹å†…å®¹æå– URL æ¨¡å¼: $url_line" >&2
              asset_pattern=""
            fi

            # ç¡®ä¿å®Œæ•´è¾“å‡ºï¼Œé˜²æ­¢æˆªæ–­
            if [[ -n "$homepage" && -n "$asset_pattern" ]]; then
              printf "%s|%s\n" "$homepage" "$asset_pattern"
            else
              echo "$homepage|$asset_pattern"
            fi
          }

          # å¤„ç†é GitHub ä»“åº“çš„é€šç”¨æ›´æ–°é€»è¾‘
          update_non_github_cask() {
            local cask_file="$1"
            echo "ğŸŒ å¤„ç†é GitHub ä»“åº“: $cask_file"
            
            local cask_name
            cask_name=$(basename "$cask_file" .rb)
            
            # æ£€æŸ¥æ˜¯å¦æœ‰ livecheck é…ç½®
            if ! grep -q 'livecheck do' "$cask_file"; then
              echo "â„¹ï¸  $cask_name æ²¡æœ‰ livecheck é…ç½®ï¼Œè·³è¿‡æ›´æ–°"
              return
            fi
            
            # æå– livecheck ç­–ç•¥
            local livecheck_strategy
            livecheck_strategy=$(grep -A 10 'livecheck do' "$cask_file" | grep -E 'strategy\s+:' | \
              sed -E 's/.*strategy\s+:([a-zA-Z_]+).*/\1/' | head -1)
            
            echo "ğŸ” æ£€æµ‹åˆ° livecheck ç­–ç•¥: $livecheck_strategy"
            
            case "$livecheck_strategy" in
              "sparkle")
                handle_sparkle_update "$cask_file" "$cask_name"
                ;;
              "page_match")
                handle_page_match_update "$cask_file" "$cask_name"
                ;;
              *)
                echo "â„¹ï¸  æš‚ä¸æ”¯æŒ $livecheck_strategy ç­–ç•¥ï¼Œè·³è¿‡æ›´æ–°"
                ;;
            esac
          }
          
          # å¤„ç† Sparkle feed æ›´æ–°
          handle_sparkle_update() {
            local cask_file="$1"
            local cask_name="$2"
            
            echo "ğŸ” ä½¿ç”¨ Sparkle ç­–ç•¥è·å–æ›´æ–°ä¿¡æ¯"
            
            # æå–å½“å‰ç‰ˆæœ¬
            local current_version
            current_version=$(grep -E '^\s*version\s+' "$cask_file" | head -1 | \
              sed -E 's/.*version\s+"([^"]+)".*/\1/')
            
            echo "ğŸ“‹ å½“å‰ç‰ˆæœ¬: $current_version"
            
            # è·å– Sparkle feed URL
            local sparkle_url
            sparkle_url=$(grep -A 10 'livecheck do' "$cask_file" | grep -E 'url\s+".*xml"' | \
              sed -E 's/.*url\s+"([^"]+)".*/\1/')
            
            if [[ -n "$sparkle_url" ]]; then
              # æ›¿æ¢ç‰ˆæœ¬å˜é‡ï¼ˆé€šç”¨å¤„ç†ï¼‰
              if [[ "$sparkle_url" == *"#{version.major}"* ]]; then
                local major_version
                major_version=$(echo "$current_version" | cut -d',' -f1 | cut -d'.' -f1)
                sparkle_url=$(echo "$sparkle_url" | sed "s/#{version.major}/$major_version/g")
              fi
              
              echo "ğŸ”— Sparkle feed URL: $sparkle_url"
              
              # è·å– Sparkle feed å†…å®¹
              local feed_content
              feed_content=$(curl -s "$sparkle_url" 2>/dev/null)
              
              if [[ -n "$feed_content" ]]; then
                echo "ğŸ“„ æˆåŠŸè·å– Sparkle feed å†…å®¹"
                
                # ä» XML ä¸­æå–æœ€æ–°çš„ enclosure URLï¼ˆé€šç”¨åŒ¹é…ï¼‰
                local latest_url
                latest_url=$(echo "$feed_content" | grep -o 'url="[^"]*\.(zip|dmg|pkg)"' | head -1 | sed 's/url="//;s/"//')
                
                if [[ -n "$latest_url" ]]; then
                  echo "ğŸ”— æ‰¾åˆ°æœ€æ–°ä¸‹è½½é“¾æ¥: $latest_url"
                  
                  # é€šç”¨ç‰ˆæœ¬æå–é€»è¾‘
                  local new_version
                  new_version=$(extract_version_from_url "$latest_url" "$current_version")
                  
                  if [[ -n "$new_version" && "$new_version" != "$current_version" ]]; then
                    echo "ğŸ“¦ å‘ç°æ–°ç‰ˆæœ¬: $current_version â†’ $new_version"
                    
                    # ä¸‹è½½å¹¶è®¡ç®— SHA256
                    echo "ğŸ“¥ æ­£åœ¨ä¸‹è½½å¹¶è®¡ç®— SHA256..."
                    local sha256
                    sha256=$(curl -sL --fail "$latest_url" | shasum -a 256 | awk '{print $1}')
                    
                    if [[ -n "$sha256" && ${#sha256} -eq 64 ]]; then
                      echo "ğŸ”’ è®¡ç®—çš„ SHA256: $sha256"
                      
                      # æ›´æ–° cask æ–‡ä»¶
                      sed -i "s/version \".*\"/version \"$new_version\"/" "$cask_file"
                      sed -i "s/sha256 \".*\"/sha256 \"$sha256\"/" "$cask_file"
                      
                      echo "âœ… æˆåŠŸæ›´æ–° $cask_name"
                      echo "ğŸ“ ç‰ˆæœ¬æ›´æ–°: $current_version â†’ $new_version"
                    else
                      echo "âŒ è®¡ç®— SHA256 å¤±è´¥"
                    fi
                  else
                    echo "â„¹ï¸  $cask_name å·²æ˜¯æœ€æ–°ç‰ˆæœ¬æˆ–æ— æ³•è§£æç‰ˆæœ¬"
                  fi
                else
                  echo "âš ï¸  æ— æ³•ä» Sparkle feed ä¸­æå–ä¸‹è½½é“¾æ¥"
                fi
              else
                echo "âš ï¸  æ— æ³•è·å– Sparkle feed å†…å®¹"
              fi
            else
              echo "âš ï¸  æœªæ‰¾åˆ° Sparkle feed URL"
            fi
          }
          
          # å¤„ç†é¡µé¢åŒ¹é…æ›´æ–°
          handle_page_match_update() {
            local cask_file="$1"
            local cask_name="$2"
            
            echo "ğŸ” ä½¿ç”¨é¡µé¢åŒ¹é…ç­–ç•¥è·å–æ›´æ–°ä¿¡æ¯"
            echo "â„¹ï¸  é¡µé¢åŒ¹é…ç­–ç•¥æš‚æœªå®ç°ï¼Œè·³è¿‡ $cask_name"
          }
          
          # ä» URL ä¸­æå–ç‰ˆæœ¬ä¿¡æ¯çš„é€šç”¨å‡½æ•°
          extract_version_from_url() {
            local url="$1"
            local current_version="$2"
            
            # æå–æ–‡ä»¶å
            local filename
            filename=$(basename "$url")
            
            # å°è¯•å¤šç§ç‰ˆæœ¬åŒ¹é…æ¨¡å¼
            local version_patterns=(
              # æ¨¡å¼1: App-x.x.x-xxxx-hash.zip (å¦‚ Surge)
              's/.*-([0-9]+\.[0-9]+\.[0-9]+)-([0-9]+)-([a-f0-9]+)\..*/\1,\2,\3/'
              # æ¨¡å¼2: App-x.x.x.zip
              's/.*-([0-9]+\.[0-9]+\.[0-9]+)\..*/\1/'
              # æ¨¡å¼3: App_x.x.x.zip
              's/.*_([0-9]+\.[0-9]+\.[0-9]+)\..*/\1/'
              # æ¨¡å¼4: Appx.x.x.zip
              's/.*([0-9]+\.[0-9]+\.[0-9]+)\..*/\1/'
            )
            
            for pattern in "${version_patterns[@]}"; do
              local extracted_version
              extracted_version=$(echo "$filename" | sed -E "$pattern")
              
              # æ£€æŸ¥æ˜¯å¦æˆåŠŸæå–åˆ°ç‰ˆæœ¬ï¼ˆä¸ç­‰äºåŸæ–‡ä»¶åï¼‰
              if [[ "$extracted_version" != "$filename" && -n "$extracted_version" ]]; then
                echo "$extracted_version"
                return 0
              fi
            done
            
            echo "" # æœªæ‰¾åˆ°ç‰ˆæœ¬
            return 1
          }

          # æ›´æ–°å•ä¸ª cask æ–‡ä»¶çš„å‡½æ•°
          update_cask() {
            local cask_file="$1"
            local repo_url="$2"
            local asset_pattern="$3"

            echo "ğŸ”„ æ­£åœ¨å¤„ç† $cask_file..."

            # æ£€æŸ¥æ˜¯å¦ä¸º GitHub ä»“åº“
            if [[ "$repo_url" == *"github.com"* && -n "$asset_pattern" ]]; then
              owner_repo=$(echo "$repo_url" | sed -e 's|https://github.com/||' -e 's|/$||')

              # è·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯ï¼ˆå¸¦é‡è¯•æœºåˆ¶å’Œé€Ÿç‡é™åˆ¶å¤„ç†ï¼‰
              echo "æ­£åœ¨è·å– $owner_repo çš„æœ€æ–°ç‰ˆæœ¬..."

              # æ™ºèƒ½APIé€Ÿç‡é™åˆ¶ç®¡ç†
              check_and_handle_rate_limit() {
                local min_remaining=${1:-20}  # æœ€å°å‰©ä½™è¯·æ±‚æ•°
                local rate_limit_check
                local remaining
                local reset_time
                local current_time
                local wait_time

                rate_limit_check=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "https://api.github.com/rate_limit")
                remaining=$(echo "$rate_limit_check" | jq -r '.rate.remaining // 0')

                echo "ğŸ“Š APIå‰©ä½™è¯·æ±‚æ•°: $remaining" >&2

                if [[ "$remaining" -lt "$min_remaining" ]]; then
                  reset_time=$(echo "$rate_limit_check" | jq -r '.rate.reset // 0')
                  current_time=$(date +%s)
                  wait_time=$((reset_time - current_time + 60))

                  if [[ $wait_time -gt 0 && $wait_time -lt 3600 ]]; then
                    echo "â³ APIé€Ÿç‡é™åˆ¶å³å°†è€—å°½ï¼Œæ™ºèƒ½ç­‰å¾… $wait_time ç§’..." >&2
                    sleep $wait_time
                    return 0
                  else
                    echo "âš ï¸  APIé€Ÿç‡é™åˆ¶è€—å°½ä¸”é‡ç½®æ—¶é—´å¼‚å¸¸ï¼Œè·³è¿‡å½“å‰æ“ä½œ" >&2
                    return 1
                  fi
                fi

                # æ·»åŠ è¯·æ±‚é—´éš”ï¼Œé¿å…è¿‡äºé¢‘ç¹çš„APIè°ƒç”¨
                sleep 2
                return 0
              }

              # æ£€æŸ¥APIé€Ÿç‡é™åˆ¶
              if ! check_and_handle_rate_limit 15; then
                echo "âŒ APIé€Ÿç‡é™åˆ¶å¤„ç†å¤±è´¥ï¼Œè·³è¿‡ $cask_file" >&2
                return
              fi

              # é¦–å…ˆæ£€æŸ¥ä»“åº“æ˜¯å¦å­˜åœ¨æˆ–å·²é‡å®šå‘
              repo_check=$(curl -s -I -H "Authorization: token $GITHUB_TOKEN" \
                "https://api.github.com/repos/$owner_repo")

              if [[ "$repo_check" == *"301 Moved Permanently"* || "$repo_check" == *"302 Found"* ]]; then
                echo "âš ï¸  ä»“åº“ $owner_repo å·²è¢«ç§»åŠ¨æˆ–é‡å‘½å" >&2

                # å°è¯•è·å–æ–°çš„ä»“åº“åœ°å€
                new_location=$(echo "$repo_check" | grep -i "location:" | sed 's/.*location: *//i' | tr -d '\r')
                if [[ -n "$new_location" && "$new_location" == *"github.com"* ]]; then
                  new_owner_repo=$(echo "$new_location" | \
                    sed -E 's|.*github.com/([^/]+/[^/]+).*|\1|')
                  echo "ğŸ”„ å°è¯•æ–°ä»“åº“: $new_owner_repo" >&2
                  owner_repo="$new_owner_repo"
                else
                  echo "âŒ æ— æ³•ç¡®å®š $cask_file çš„æ–°ä»“åº“ä½ç½®" >&2
                  return
                fi
              fi

              # æ™ºèƒ½APIè¯·æ±‚é‡è¯•æœºåˆ¶
              make_api_request() {
                local url="$1"
                local max_retries=5
                local retry_count=0
                local backoff_base=3
                local response

                while [[ $retry_count -lt $max_retries ]]; do
                  # åœ¨æ¯æ¬¡è¯·æ±‚å‰æ£€æŸ¥é€Ÿç‡é™åˆ¶
                  if ! check_and_handle_rate_limit 10; then
                    echo "âŒ APIé€Ÿç‡é™åˆ¶æ£€æŸ¥å¤±è´¥ï¼Œç»ˆæ­¢è¯·æ±‚" >&2
                    return 1
                  fi

                  echo "ğŸ“¡ å‘èµ·APIè¯·æ±‚ (å°è¯• $((retry_count + 1))/$max_retries): $url" >&2
                  response=$(curl -s -w "HTTP_CODE:%{http_code}" \
                    -H "Authorization: token $GITHUB_TOKEN" "$url")

                  local http_code
                  http_code=$(echo "$response" | grep -o "HTTP_CODE:[0-9]*" | cut -d: -f2)
                  local body
                  body=$(echo "$response" | sed 's/HTTP_CODE:[0-9]*$//')

                  # æ ¹æ®HTTPçŠ¶æ€ç åˆ¤æ–­æ˜¯å¦éœ€è¦é‡è¯•
                  case "$http_code" in
                    200)
                      # æˆåŠŸå“åº”ï¼Œæ£€æŸ¥å†…å®¹æ˜¯å¦æœ‰æ•ˆ
                      if [[ -n "$body" && "$body" != *"rate limit"* && \
                            "$body" != *"Not Found"* ]]; then
                        echo "$body"
                        return 0
                      fi
                      ;;
                    403)
                      # å¯èƒ½æ˜¯é€Ÿç‡é™åˆ¶ï¼Œç­‰å¾…æ›´é•¿æ—¶é—´
                      echo "âš ï¸  æ”¶åˆ°403å“åº”ï¼Œå¯èƒ½è§¦å‘é€Ÿç‡é™åˆ¶" >&2
                      if ! check_and_handle_rate_limit 5; then
                        return 1
                      fi
                      ;;
                    404)
                      # èµ„æºä¸å­˜åœ¨ï¼Œä¸éœ€è¦é‡è¯•
                      echo "âŒ èµ„æºä¸å­˜åœ¨ (404): $url" >&2
                      return 1
                      ;;
                    301|302)
                      # é‡å®šå‘ï¼Œå°è¯•è·å–æ–°ä½ç½®
                      echo "ğŸ”„ æ£€æµ‹åˆ°é‡å®šå‘ ($http_code)" >&2
                      ;;
                    *)
                      echo "âš ï¸  æ”¶åˆ°æ„å¤–HTTPçŠ¶æ€ç : $http_code" >&2
                      ;;
                  esac

                  retry_count=$((retry_count + 1))
                  if [[ $retry_count -lt $max_retries ]]; then
                    local wait_time
                    wait_time=$((backoff_base ** retry_count))
                    echo "â³ è¯·æ±‚å¤±è´¥ï¼ŒæŒ‡æ•°é€€é¿ç­‰å¾… $wait_time ç§’åé‡è¯•..." >&2
                    sleep $wait_time
                  fi
                done

                echo "âŒ APIè¯·æ±‚æœ€ç»ˆå¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°" >&2
                return 1
              }

              # ä½¿ç”¨æ™ºèƒ½è¯·æ±‚æœºåˆ¶è·å–æœ€æ–°ç‰ˆæœ¬
              latest_release=$(make_api_request \
                "https://api.github.com/repos/$owner_repo/releases/latest")

              if [[ -z "$latest_release" || "$latest_release" == *"rate limit"* || \
                    "$latest_release" == *"Not Found"* ]]; then
                echo "âŒ GitHub API è¯·æ±‚å¤±è´¥æˆ–è¾¾åˆ°é€Ÿç‡é™åˆ¶ $cask_file (ä»“åº“: $owner_repo)" >&2
                return
              fi

              latest_version=$(echo "$latest_release" | jq -r '.tag_name' | sed 's/^v//')

              if [[ "$latest_version" == "null" || -z "$latest_version" ]]; then
                echo "âŒ è·å– $cask_file æœ€æ–°ç‰ˆæœ¬å¤±è´¥ (ä»“åº“: $owner_repo)" >&2
                echo "API å“åº”: $(echo "$latest_release" | jq -r '.message // "æ— æ¶ˆæ¯"')" >&2

                # å¦‚æœæ˜¯ hiddifyï¼Œå°è¯•ä½¿ç”¨æ–°çš„ä»“åº“å
                if [[ "$owner_repo" == *"hiddify"* && "$owner_repo" == *"hiddify-next"* ]]; then
                  echo "ğŸ”„ å°è¯• hiddify çš„å¤‡ç”¨ä»“åº“å..." >&2
                  owner_repo="hiddify/hiddify-app"
                  latest_release=$(curl -s \
                    "https://api.github.com/repos/$owner_repo/releases/latest")
                  latest_version=$(echo "$latest_release" | jq -r '.tag_name' | sed 's/^v//')

                  if [[ "$latest_version" != "null" && -n "$latest_version" ]]; then
                    echo "âœ… åœ¨å¤‡ç”¨ä»“åº“ä¸­æ‰¾åˆ°ç‰ˆæœ¬: $owner_repo" >&2
                  else
                    echo "âŒ å¤‡ç”¨ä»“åº“ä¹Ÿå¤±è´¥äº†" >&2
                    return
                  fi
                else
                  return
                fi
              fi

              echo "æ‰¾åˆ°æœ€æ–°ç‰ˆæœ¬: $latest_version"

              # è·å–åŒ¹é…çš„èµ„æºæ–‡ä»¶
               echo "æœç´¢åŒ¹é…æ¨¡å¼çš„èµ„äº§: $asset_pattern"

               # åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„èµ„æºæ–‡ä»¶ç”¨äºè°ƒè¯•
               echo "å¯ç”¨èµ„äº§:"
               echo "$latest_release" | jq -r '.assets[].name' | sed 's/^/  - /'

               # é€šç”¨çš„èµ„æºæ–‡ä»¶åŒ¹é…é€»è¾‘
               # é¦–å…ˆå°è¯•å®Œå…¨åŒ¹é…æ¨¡å¼ï¼ˆä¿®å¤ jq è½¬ä¹‰é—®é¢˜ï¼‰
               # å¯¹äºå›ºå®šæ–‡ä»¶åï¼ˆå¦‚ Hiddify-MacOS.dmgï¼‰ï¼Œä½¿ç”¨ç²¾ç¡®åŒ¹é…
               if [[ "$asset_pattern" =~ ^[A-Za-z0-9._-]+\\\.[a-z]+$ ]]; then
                 # å›ºå®šæ–‡ä»¶åï¼Œä½¿ç”¨ç²¾ç¡®åŒ¹é…
                 fixed_name=${asset_pattern//\\./.}
                 download_url=$(echo "$latest_release" | \
                   jq -r ".assets[] | select(.name == \"$fixed_name\") | .browser_download_url" | head -1)
                 echo "ğŸ¯ å¯¹å›ºå®šæ–‡ä»¶åä½¿ç”¨ç²¾ç¡®åŒ¹é…: $fixed_name"
               else
                 # ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…
                 echo "ğŸ¯ ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…: $asset_pattern" >&2
                 # å¯¹ asset_pattern è¿›è¡Œé€‚å½“çš„è½¬ä¹‰å¤„ç†ï¼Œé¿å… shell è½¬ä¹‰é—®é¢˜
                 escaped_pattern=$(printf '%s' "$asset_pattern" | sed 's/\\/\\\\/g')
                 download_url=$(echo "$latest_release" | \
                   jq -r --arg pattern "$escaped_pattern" '.assets[] | select(.name | test($pattern)) | .browser_download_url' | head -1)

                 # å¦‚æœæ­£åˆ™åŒ¹é…å¤±è´¥ï¼Œå°è¯•æ›´ç®€å•çš„æ¨¡å¼
                 if [[ -z "$download_url" || "$download_url" == "null" ]]; then
                   echo "ğŸ”„ æ­£åˆ™åŒ¹é…å¤±è´¥ï¼Œå°è¯•ç®€åŒ–æ¨¡å¼..." >&2
                   # ç§»é™¤å¤æ‚çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œä½¿ç”¨æ›´ç®€å•çš„åŒ¹é…
                   simple_pattern=$(echo "$asset_pattern" | sed -E 's/\\\././g' | \
                     sed -E 's/\[0-9\]\+\\\.[0-9\]\+\\\.[0-9\]\+/[0-9.]*/g' | \
                     sed -E 's/\([^)]*\)/*/g')
                   echo "ğŸ¯ ç®€åŒ–åçš„æ¨¡å¼: $simple_pattern" >&2
                   download_url=$(echo "$latest_release" | \
                     jq -r ".assets[] | select(.name | contains(\"$simple_pattern\")) | .browser_download_url" | \
                     head -1)
                 fi
               fi

               # å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„èµ„æºï¼Œå°è¯•æ™ºèƒ½åŒ¹é…
                if [[ -z "$download_url" || "$download_url" == "null" ]]; then
                  echo "æœªæ‰¾åˆ°ç²¾ç¡®åŒ¹é…ï¼Œå¯åŠ¨æ™ºèƒ½å¤šè½®å›é€€åŒ¹é…ç­–ç•¥..."

                  # ä»åŸå§‹æ–‡ä»¶åä¸­æå–åŸºæœ¬ä¿¡æ¯
                  local base_name
                  base_name=$(basename "$cask_file" .rb)
                  local file_ext=""

                  # ä» asset_pattern ä¸­æ¨æ–­æ–‡ä»¶æ‰©å±•å
                  if [[ "$asset_pattern" == *".dmg"* ]]; then
                    file_ext="dmg"
                  elif [[ "$asset_pattern" == *".zip"* ]]; then
                    file_ext="zip"
                  elif [[ "$asset_pattern" == *".pkg"* ]]; then
                    file_ext="pkg"
                  else
                    file_ext="(dmg|zip|pkg)"
                  fi

                  echo "å¯åŠ¨æ™ºèƒ½åŒ¹é… base_name: $base_name, file_ext: $file_ext"

                  # è°ƒç”¨æ™ºèƒ½åŒ¹é…å‡½æ•°
                  download_url=$(find_matching_asset "$latest_release" "$base_name" "$file_ext")

                  if [[ -n "$download_url" && "$download_url" != "null" ]]; then
                    local matched_asset
                    matched_asset=$(echo "$latest_release" | \
                      jq -r ".assets[] | select(.browser_download_url == \"$download_url\") | .name")
                    echo "ğŸ‰ æ™ºèƒ½åŒ¹é…æˆåŠŸæ‰¾åˆ°èµ„äº§: $matched_asset"
                  fi
                fi

              if [[ -n "$download_url" && "$download_url" != "null" ]]; then
                local matched_asset
                 matched_asset=$(echo "$latest_release" | \
                   jq -r ".assets[] | select(.browser_download_url == \"$download_url\") | .name")
                echo "âœ… æ‰¾åˆ°åŒ¹é…çš„èµ„äº§: $matched_asset"
                echo "ğŸ“¥ ä¸‹è½½é“¾æ¥: $download_url"

                # è·å–å½“å‰ç‰ˆæœ¬è¿›è¡Œæ¯”è¾ƒ
                current_version=$(grep -E '^\s*version\s+"' "$cask_file" | sed -E 's/.*version\s+"([^"]+)".*/\1/')

                if [[ "$current_version" == "$latest_version" ]]; then
                  echo "â„¹ï¸  $cask_file å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ (ç‰ˆæœ¬ $current_version)"
                else
                  echo "ğŸ“¥ æ­£åœ¨ä¸‹è½½å¹¶è®¡ç®— SHA256: $download_url..."

                  # ä½¿ç”¨æ›´å¥å£®çš„ä¸‹è½½å’Œ SHA256 è®¡ç®—æ–¹æ³•
                  sha256=$(curl -sL --fail "$download_url" | \
                    shasum -a 256 | awk '{print $1}')

                  if [[ -n "$sha256" && ${#sha256} -eq 64 ]]; then
                    echo "ğŸ”’ è®¡ç®—çš„ SHA256: $sha256"

                    # æ£€æŸ¥æ˜¯å¦ä¸ºå¤šæ¶æ„ caskï¼ˆåŒ…å« arch å˜é‡ï¼‰
                    if grep -q 'arch arm:' "$cask_file"; then
                      echo "ğŸ—ï¸  æ£€æµ‹åˆ°å¤šæ¶æ„ caskï¼Œæ­£åœ¨é€‚å½“æ›´æ–°..."

                      # å¯¹äºå¤šæ¶æ„ caskï¼Œéœ€è¦æ›´æ–°å¯¹åº”æ¶æ„çš„ SHA256
                      if [[ "$download_url" == *"aarch64"* || "$download_url" == *"arm64"* ]]; then
                        # æ›´æ–° ARM æ¶æ„çš„ SHA256
                        sed -i "s/version \".*\"/version \"$latest_version\"/" "$cask_file"
                        sed -i "s/sha256 arm:\s*\"[^\"]*\"/sha256 arm:   \"$sha256\"/" "$cask_file"
                        echo "âœ… å·²æ›´æ–° $cask_file çš„ ARM SHA256 åˆ°ç‰ˆæœ¬ $latest_version"
                      elif [[ "$download_url" == *"x64"* || "$download_url" == *"x86_64"* ]]; then
                        # æ›´æ–° Intel æ¶æ„çš„ SHA256
                        sed -i "s/version \".*\"/version \"$latest_version\"/" "$cask_file"
                        sed -i \
                          "s/sha256.*intel:\s*\"[^\"]*\"/sha256 arm:   \"$sha256\",\n         intel: \"$sha256\"/" \
                          "$cask_file"
                        echo "âœ… å·²æ›´æ–° $cask_file çš„ Intel SHA256 åˆ°ç‰ˆæœ¬ $latest_version"
                      fi
                    else
                      # å•æ¶æ„ cask çš„æ ‡å‡†æ›´æ–°
                      sed -i "s/version \".*\"/version \"$latest_version\"/" "$cask_file"
                      sed -i "s/sha256 \".*\"/sha256 \"$sha256\"/" "$cask_file"
                      echo "âœ… å·²æ›´æ–° $cask_file åˆ°ç‰ˆæœ¬ $latest_version"
                    fi

                    echo "ğŸ“ å¯¹ $cask_file çš„æ›´æ”¹:"
                    echo "   ç‰ˆæœ¬: $current_version â†’ $latest_version"
                    echo "   èµ„äº§: $matched_asset"
                  else
                    echo "âŒ è®¡ç®— $cask_file çš„æœ‰æ•ˆ SHA256 å¤±è´¥ (å¾—åˆ°: $sha256)"
                  fi
                fi
              else
                echo "âŒ æœªæ‰¾åˆ° $cask_file çš„åŒ¹é…èµ„äº§"
                echo "   ä½¿ç”¨çš„æ¨¡å¼: $asset_pattern"
                echo "   ä»“åº“: $repo_url"
                echo "   åŸºç¡€åç§°: $base_name"
                echo "   å¯ç”¨èµ„äº§:"
                echo "$latest_release" | jq -r '.assets[].name' | sed 's/^/     - /'

                # ä½¿ç”¨æ™ºèƒ½åŒ¹é…å‡½æ•°è¿›è¡Œå›é€€åŒ¹é…
                local base_name_fallback
                base_name_fallback=$(basename "$cask_file" .rb)
                local file_ext_fallback="(dmg|zip|pkg)"
                fallback_url=$(find_matching_asset "$latest_release" "$base_name_fallback" "$file_ext_fallback")
                
                if [[ -n "$fallback_url" && "$fallback_url" != "null" ]]; then
                  download_url="$fallback_url"
                  matched_asset=$(echo "$latest_release" | \
                    jq -r ".assets[] | select(.browser_download_url == \"$download_url\") | .name")
                  echo "âœ… æ‰¾åˆ°æ™ºèƒ½åŒ¹é…: $matched_asset"
                  echo "ğŸ“¥ æ™ºèƒ½åŒ¹é…ä¸‹è½½é“¾æ¥: $download_url"

                  # é‡æ–°æ‰§è¡Œä¸‹è½½å’Œæ›´æ–°é€»è¾‘
                  current_version=$(grep -E '^\s*version\s+"' "$cask_file" | \
                    sed -E 's/.*version\s+"([^"]+)".*/\1/')

                  if [[ "$current_version" != "$latest_version" ]]; then
                    echo "ğŸ“¥ æ­£åœ¨ä¸‹è½½å¹¶è®¡ç®—æ™ºèƒ½åŒ¹é…é“¾æ¥çš„ SHA256..."
                    sha256=$(curl -sL --fail "$download_url" | \
                      shasum -a 256 | awk '{print $1}')

                    if [[ -n "$sha256" && ${#sha256} -eq 64 ]]; then
                      echo "ğŸ”’ è®¡ç®—çš„ SHA256: $sha256"
                      sed -i "s/version \".*\"/version \"$latest_version\"/" "$cask_file"
                      sed -i "s/sha256 \".*\"/sha256 \"$sha256\"/" "$cask_file"
                      echo "âœ… ä½¿ç”¨æ™ºèƒ½åŒ¹é…å·²æ›´æ–° $cask_file åˆ°ç‰ˆæœ¬ $latest_version"
                      echo "ğŸ“ å¯¹ $cask_file çš„æ›´æ”¹:"
                      echo "   ç‰ˆæœ¬: $current_version â†’ $latest_version"
                      echo "   èµ„äº§: $matched_asset"
                    else
                      echo "âŒ è®¡ç®—æ™ºèƒ½åŒ¹é…é“¾æ¥çš„æœ‰æ•ˆ SHA256 å¤±è´¥ (å¾—åˆ°: $sha256)"
                    fi
                  fi
                else
                  echo "âŒ æ™ºèƒ½åŒ¹é…ä¹Ÿæœªæ‰¾åˆ°åˆé€‚çš„èµ„äº§"
                fi
              fi
            else
              echo "ğŸŒ æ£€æµ‹åˆ°é GitHub ä»“åº“ï¼Œå°è¯•ä½¿ç”¨æ›¿ä»£æ›´æ–°æ–¹æ³•"
              update_non_github_cask "$cask_file"
            fi
            echo "---"
          }

          # ğŸ” å‘ç°å¹¶å¤„ç†æ‰€æœ‰ cask æ–‡ä»¶
          echo "ğŸ” åœ¨ Casks/ ç›®å½•ä¸­å‘ç° cask æ–‡ä»¶..."

          # åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨äºå¹¶è¡Œå¤„ç†
          temp_dir=$(mktemp -d)
          trap "rm -rf $temp_dir" EXIT

          # æ”¶é›†æ‰€æœ‰éœ€è¦å¤„ç†çš„caskæ–‡ä»¶
          cask_files=()
          for cask_file in Casks/*.rb; do
            if [[ -f "$cask_file" ]]; then
              cask_files+=("$cask_file")
            fi
          done

          echo "ğŸ“¦ å‘ç° ${#cask_files[@]} ä¸ª cask æ–‡ä»¶"

          # æ‰¹é‡å¤„ç†å‡½æ•°
          process_cask_batch() {
            local batch_files=("$@")
            local batch_size=${#batch_files[@]}

            echo "ğŸ”„ å¼€å§‹å¤„ç†æ‰¹æ¬¡ï¼ŒåŒ…å« $batch_size ä¸ªæ–‡ä»¶"

            for cask_file in "${batch_files[@]}"; do
              echo "ğŸ“¦ å¤„ç† cask æ–‡ä»¶: $cask_file"

              # æå–ä»“åº“ä¿¡æ¯å’Œèµ„æºæ¨¡å¼
              repo_info=$(extract_repo_info "$cask_file")
              repo_url=$(echo "$repo_info" | cut -d'|' -f1)
              asset_pattern=$(echo "$repo_info" | cut -d'|' -f2)

              echo "ğŸ”— ä»“åº“: $repo_url"
              echo "ğŸ¯ èµ„äº§æ¨¡å¼: $asset_pattern"

              # è°ƒè¯•ï¼šæ£€æŸ¥æå–çš„ä¿¡æ¯
              if [[ -z "$repo_url" || -z "$asset_pattern" ]]; then
                echo "âš ï¸  è­¦å‘Š: ä»“åº“ URL æˆ–èµ„äº§æ¨¡å¼ä¸ºç©º" >&2
                echo "   repo_info: '$repo_info'" >&2
                echo "   repo_url: '$repo_url'" >&2
                echo "   asset_pattern: '$asset_pattern'" >&2
              fi

              # æ£€æŸ¥èµ„äº§æ¨¡å¼æ˜¯å¦è¢«æˆªæ–­æˆ–æœ‰é—®é¢˜
              if [[ ${#asset_pattern} -lt 10 || "$asset_pattern" == *"(aarch64" ]]; then
                echo "âš ï¸  è­¦å‘Š: èµ„äº§æ¨¡å¼è¢«æˆªæ–­æˆ–ä¸å®Œæ•´ (${#asset_pattern} å­—ç¬¦): '$asset_pattern'" >&2
                echo "ğŸ” é‡æ–°æå–å®Œæ•´çš„èµ„äº§æ¨¡å¼..." >&2

                # é‡æ–°æå–å®Œæ•´çš„ URL æ¨¡æ¿
                url_line=$(grep -E '^\s*url\s+' "$cask_file" | head -1)
                echo "å®Œæ•´ URL è¡Œ: $url_line" >&2

                if [[ "$url_line" =~ url[[:space:]]+\"([^\"]+)\" ]]; then
                  url_template="${BASH_REMATCH[1]}"
                  filename=$(echo "$url_template" | sed -E 's/.*\///')
                  echo "æå–çš„æ–‡ä»¶å: $filename" >&2

                  # é‡æ–°ç”Ÿæˆå®Œæ•´çš„èµ„äº§æ¨¡å¼
                  if [[ "$filename" == *"#{version}"* && "$filename" == *"#{arch}"* ]]; then
                    # å¤„ç†åŒ…å«ç‰ˆæœ¬å’Œæ¶æ„å˜é‡çš„æƒ…å†µ
                    asset_pattern="$filename"
                    asset_pattern=$(echo "$asset_pattern" | sed -E 's/#\{version\}/[0-9]+\.[0-9]+\.[0-9]+/g')
                    asset_pattern=$(echo "$asset_pattern" | sed -E 's/#\{arch\}/(aarch64|arm64|x64|x86_64)/g')
                    asset_pattern=$(echo "$asset_pattern" | sed -E 's/\./\\./g')
                    echo "é‡æ–°ç”Ÿæˆçš„å®Œæ•´æ¨¡å¼: $asset_pattern" >&2
                  fi
                fi
              fi

              # æ›´æ–° cask
              update_cask "$cask_file" "$repo_url" "$asset_pattern"

              # åœ¨å¤„ç†é—´éš”ä¸­æ·»åŠ çŸ­æš‚å»¶è¿Ÿï¼Œé¿å…APIè¿‡è½½
              sleep 1
            done
          }

          # åˆ†æ‰¹å¤„ç†ï¼Œæ¯æ‰¹3ä¸ªæ–‡ä»¶ï¼Œé¿å…APIé€Ÿç‡é™åˆ¶
          batch_size=3
          total_files=${#cask_files[@]}

          for ((i=0; i<total_files; i+=batch_size)); do
            batch=("${cask_files[@]:i:batch_size}")
            batch_num=$((i/batch_size + 1))
            total_batches=$(((total_files + batch_size - 1) / batch_size))

            echo "ğŸ“Š å¤„ç†æ‰¹æ¬¡ $batch_num/$total_batches (æ–‡ä»¶ $((i+1))-$((i+${#batch[@]}))/$total_files)"

            process_cask_batch "${batch[@]}"

            # æ‰¹æ¬¡é—´ç­‰å¾…ï¼Œç¡®ä¿APIé€Ÿç‡é™åˆ¶ä¸è¢«è§¦å‘
            if [[ $i -lt $((total_files - batch_size)) ]]; then
              echo "â³ æ‰¹æ¬¡é—´ç­‰å¾… 10 ç§’ï¼Œé¿å…APIé€Ÿç‡é™åˆ¶..."
              sleep 10
            fi
          done

          echo "ğŸ‰ æ‰€æœ‰ cask æ–‡ä»¶å·²å¤„ç†å®Œæˆ!"

      - name: Commit and push changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add Casks/

          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
          if ! git diff --quiet || ! git diff --staged --quiet; then
            # è·å–å·²æ›´æ”¹çš„ cask æ–‡ä»¶åˆ—è¡¨
            changed_casks=$(git diff --cached --name-only | grep 'Casks/.*\.rb$' | \
              sed 's|Casks/||' | sed 's|\.rb$||' | tr '\n' ' ' | sed 's/ $//')

            if [[ -n "$changed_casks" ]]; then
              # ä¸ºæ¯ä¸ªæ›´æ”¹çš„ cask è·å–æ–°ç‰ˆæœ¬ä¿¡æ¯
              commit_details=""
              for cask in $changed_casks; do
                cask_file="Casks/${cask}.rb"
                if [[ -f "$cask_file" ]]; then
                  new_version=$(grep -E '^\s*version\s+' "$cask_file" | head -1 | \
                    sed -E 's/.*version\s+"([^"]+)".*/\1/')
                  if [[ -n "$new_version" ]]; then
                    commit_details="${commit_details}\n- ${cask}: æ›´æ–°åˆ° v${new_version}"
                  else
                    commit_details="${commit_details}\n- ${cask}: å·²æ›´æ–°"
                  fi
                fi
              done

              # æ„å»ºè¯¦ç»†çš„æäº¤ä¿¡æ¯
              commit_message="ğŸš€ æ›´æ–° Homebrew Casks

              æœ¬æ¬¡æ›´æ–°åŒ…å«ä»¥ä¸‹åº”ç”¨:$(echo -e "${commit_details}")

              ğŸ“… æ›´æ–°æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
              ğŸ¤– è‡ªåŠ¨æ›´æ–° by GitHub Actions"

              git commit -m "$commit_message"
              echo "âœ… å·²æäº¤æ›´æ”¹ï¼ŒåŒ…å«ä»¥ä¸‹åº”ç”¨æ›´æ–°: $changed_casks"
            else
              git commit -m "ğŸ”§ æ›´æ–° Homebrew Casks é…ç½®æ–‡ä»¶"
              echo "âœ… å·²æäº¤é…ç½®æ–‡ä»¶æ›´æ”¹"
            fi

            # åªåœ¨æœ‰æäº¤æ—¶æ‰æ¨é€
            echo "ğŸ“¤ æ­£åœ¨æ¨é€æ›´æ”¹åˆ°è¿œç¨‹ä»“åº“..."
            git pull --rebase origin main || {
              echo "âš ï¸  æ‹‰å–è¿œç¨‹æ›´æ”¹å¤±è´¥ï¼Œå°è¯•å¼ºåˆ¶æ¨é€..."
              git push --force-with-lease
            } && git push
            echo "âœ… æ›´æ”¹å·²æˆåŠŸæ¨é€åˆ°è¿œç¨‹ä»“åº“"
          else
            echo "â„¹ï¸  æ²¡æœ‰æ£€æµ‹åˆ°éœ€è¦æäº¤çš„æ›´æ”¹ï¼Œè·³è¿‡æ¨é€æ“ä½œ"
          fi
