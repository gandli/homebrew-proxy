---
name: Update Casks

"on":
  schedule:
    - cron: 0 2 * * *
  workflow_dispatch: {}

# é˜²æ­¢å¹¶å‘æ‰§è¡Œï¼Œé¿å…APIé€Ÿç‡é™åˆ¶å†²çª
concurrency:
  group: update-casks
  cancel-in-progress: false

jobs:
  update:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # è®¾ç½®è¶…æ—¶æ—¶é—´
    steps:
      - uses: actions/checkout@v4

      # ç¼“å­˜Rubyä¾èµ–
      - name: Cache Ruby dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gem
            vendor/bundle
          key: ${{ runner.os }}-ruby-3.0-${{ hashFiles('**/Gemfile.lock', '**/gems.locked') }}
          restore-keys: |
            ${{ runner.os }}-ruby-3.0-
            ${{ runner.os }}-ruby-

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.0'
          bundler-cache: true  # è‡ªåŠ¨ç¼“å­˜bundlerä¾èµ–

      - name: Update all casks
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: |
          # ä» cask æ–‡ä»¶ä¸­æå– GitHub ä»“åº“ä¿¡æ¯çš„å‡½æ•°
          extract_repo_info() {
            local cask_file="$1"

            # æå– homepage URL (GitHub ä»“åº“)
            local homepage
            homepage=$(grep -E '^\s*homepage\s+"' "$cask_file" | sed -E 's/.*homepage\s+"([^"]+)".*/\1/')

            # å¦‚æœ homepage ä¸æ˜¯ GitHubï¼Œå°è¯•ä» URL ä¸­æå–
            if [[ "$homepage" != *"github.com"* ]]; then
              homepage=$(grep -E '^\s*url\s+"' "$cask_file" | \
                sed -E 's/.*"https:\/\/github\.com\/([^\/]+\/[^\/]+)\/.*/https:\/\/github.com\/\1/' | head -1)
            fi

            # æå– URL æ¨¡å¼æ¥æ¨æ–­èµ„æºæ–‡ä»¶å
            local url_line
            url_line=$(grep -E '^\s*url\s+"' "$cask_file" | head -1)
            local asset_pattern=""

            # é€šç”¨çš„èµ„æºæ–‡ä»¶åæ¨æ–­é€»è¾‘
            # ä» URL ä¸­æå–æ–‡ä»¶åæ¨¡å¼ï¼Œæ”¯æŒç‰ˆæœ¬å’Œæ¶æ„å˜é‡æ›¿æ¢
            if [[ "$url_line" =~ url[[:space:]]+\"([^\"]+)\" ]]; then
              local url_template
              url_template="${BASH_REMATCH[1]}"

              # æå–æ–‡ä»¶åéƒ¨åˆ†ï¼ˆæœ€åä¸€ä¸ª / ä¹‹åçš„å†…å®¹ï¼‰
              local filename
              filename=$(echo "$url_template" | sed -E 's/.*\///')

              echo "ğŸ“‹ æå–çš„æ–‡ä»¶åæ¨¡æ¿: $filename" >&2

              # å¤„ç†ä¸åŒçš„æ–‡ä»¶åæ¨¡å¼
              if [[ "$filename" == *"#{"* ]]; then
                # åŒ…å«å˜é‡çš„æƒ…å†µï¼Œæ›¿æ¢ä¸ºé€šç”¨æ¨¡å¼
                asset_pattern="$filename"

                # æ›¿æ¢ç‰ˆæœ¬å˜é‡
                asset_pattern=$(echo "$asset_pattern" | sed -E 's/#\{version\}/[0-9]+\.[0-9]+\.[0-9]+/g')

                # å¤„ç†æ¶æ„å˜é‡
                if [[ "$asset_pattern" == *"#{arch}"* ]]; then
                  # å¯¹äºæœ‰æ¶æ„å˜é‡çš„æƒ…å†µï¼Œåˆ›å»ºä¸€ä¸ªæ›´å®½æ³›çš„æ¨¡å¼
                  asset_pattern=$(echo "$asset_pattern" | \
                    sed -E 's/#\{arch\}/(aarch64|arm64|x64|x86_64)/g')
                elif [[ "$asset_pattern" == *"_aarch64"* || "$asset_pattern" == *"_x64"* ]]; then
                  # å¤„ç†å›ºå®šæ¶æ„çš„æƒ…å†µ
                  asset_pattern=$(echo "$asset_pattern" | \
                    sed -E 's/_(aarch64|x64)/_(aarch64|arm64|x64|x86_64)/g')
                fi

                # è½¬ä¹‰æ­£åˆ™è¡¨è¾¾å¼ç‰¹æ®Šå­—ç¬¦
                asset_pattern=$(echo "$asset_pattern" | sed -E 's/\./\\./g')

                # è°ƒè¯•è¾“å‡ºï¼šæ˜¾ç¤ºå®Œæ•´çš„æ¨¡å¼ç”Ÿæˆè¿‡ç¨‹
                echo "ğŸ”§ åŸå§‹æ–‡ä»¶å: $filename" >&2
                echo "ğŸ”§ å¤„ç†åçš„æ¨¡å¼: $asset_pattern" >&2
                echo "ğŸ”§ æ¨¡å¼é•¿åº¦: ${#asset_pattern}" >&2
              else
                # å›ºå®šæ–‡ä»¶åçš„æƒ…å†µï¼ˆå¦‚ Hiddify-MacOS.dmgï¼‰
                asset_pattern=$(echo "$filename" | sed -E 's/\./\\./g')
              fi

              echo "ğŸ¯ ç”Ÿæˆçš„èµ„äº§æ¨¡å¼: $asset_pattern" >&2

              # æ£€æŸ¥æ¨¡å¼é•¿åº¦ï¼Œé˜²æ­¢æˆªæ–­
              if [[ ${#asset_pattern} -lt 10 ]]; then
                echo "âš ï¸  èµ„äº§æ¨¡å¼ä¼¼ä¹å¤ªçŸ­ï¼Œå¯èƒ½è¢«æˆªæ–­: '$asset_pattern'" >&2
              fi
            else
              echo "âš ï¸  æ— æ³•ä»ä»¥ä¸‹å†…å®¹æå– URL æ¨¡å¼: $url_line" >&2
              asset_pattern=""
            fi

            # ç¡®ä¿å®Œæ•´è¾“å‡ºï¼Œé˜²æ­¢æˆªæ–­
            if [[ -n "$homepage" && -n "$asset_pattern" ]]; then
              printf "%s|%s\n" "$homepage" "$asset_pattern"
            else
              echo "$homepage|$asset_pattern"
            fi
          }

          # æ›´æ–°å•ä¸ª cask æ–‡ä»¶çš„å‡½æ•°
          update_cask() {
            local cask_file="$1"
            local repo_url="$2"
            local asset_pattern="$3"

            echo "ğŸ”„ æ­£åœ¨å¤„ç† $cask_file..."

            if [[ "$repo_url" == *"github.com"* && -n "$asset_pattern" ]]; then
              owner_repo=$(echo "$repo_url" | sed -e 's|https://github.com/||' -e 's|/$||')

              # è·å–æœ€æ–°ç‰ˆæœ¬ä¿¡æ¯ï¼ˆå¸¦é‡è¯•æœºåˆ¶å’Œé€Ÿç‡é™åˆ¶å¤„ç†ï¼‰
              echo "æ­£åœ¨è·å– $owner_repo çš„æœ€æ–°ç‰ˆæœ¬..."

              # æ™ºèƒ½APIé€Ÿç‡é™åˆ¶ç®¡ç†
              check_and_handle_rate_limit() {
                local min_remaining=${1:-20}  # æœ€å°å‰©ä½™è¯·æ±‚æ•°
                local rate_limit_check
                local remaining
                local reset_time
                local current_time
                local wait_time

                rate_limit_check=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "https://api.github.com/rate_limit")
                remaining=$(echo "$rate_limit_check" | jq -r '.rate.remaining // 0')

                echo "ğŸ“Š APIå‰©ä½™è¯·æ±‚æ•°: $remaining" >&2

                if [[ "$remaining" -lt "$min_remaining" ]]; then
                  reset_time=$(echo "$rate_limit_check" | jq -r '.rate.reset // 0')
                  current_time=$(date +%s)
                  wait_time=$((reset_time - current_time + 60))

                  if [[ $wait_time -gt 0 && $wait_time -lt 3600 ]]; then
                    echo "â³ APIé€Ÿç‡é™åˆ¶å³å°†è€—å°½ï¼Œæ™ºèƒ½ç­‰å¾… $wait_time ç§’..." >&2
                    sleep $wait_time
                    return 0
                  else
                    echo "âš ï¸  APIé€Ÿç‡é™åˆ¶è€—å°½ä¸”é‡ç½®æ—¶é—´å¼‚å¸¸ï¼Œè·³è¿‡å½“å‰æ“ä½œ" >&2
                    return 1
                  fi
                fi

                # æ·»åŠ è¯·æ±‚é—´éš”ï¼Œé¿å…è¿‡äºé¢‘ç¹çš„APIè°ƒç”¨
                sleep 2
                return 0
              }

              # æ£€æŸ¥APIé€Ÿç‡é™åˆ¶
              if ! check_and_handle_rate_limit 15; then
                echo "âŒ APIé€Ÿç‡é™åˆ¶å¤„ç†å¤±è´¥ï¼Œè·³è¿‡ $cask_file" >&2
                return
              fi

              # é¦–å…ˆæ£€æŸ¥ä»“åº“æ˜¯å¦å­˜åœ¨æˆ–å·²é‡å®šå‘
              repo_check=$(curl -s -I -H "Authorization: token $GITHUB_TOKEN" \
                "https://api.github.com/repos/$owner_repo")

              if [[ "$repo_check" == *"301 Moved Permanently"* || "$repo_check" == *"302 Found"* ]]; then
                echo "âš ï¸  ä»“åº“ $owner_repo å·²è¢«ç§»åŠ¨æˆ–é‡å‘½å" >&2

                # å°è¯•è·å–æ–°çš„ä»“åº“åœ°å€
                new_location=$(echo "$repo_check" | grep -i "location:" | sed 's/.*location: *//i' | tr -d '\r')
                if [[ -n "$new_location" && "$new_location" == *"github.com"* ]]; then
                  new_owner_repo=$(echo "$new_location" | \
                    sed -E 's|.*github.com/([^/]+/[^/]+).*|\1|')
                  echo "ğŸ”„ å°è¯•æ–°ä»“åº“: $new_owner_repo" >&2
                  owner_repo="$new_owner_repo"
                else
                  echo "âŒ æ— æ³•ç¡®å®š $cask_file çš„æ–°ä»“åº“ä½ç½®" >&2
                  return
                fi
              fi

              # æ™ºèƒ½APIè¯·æ±‚é‡è¯•æœºåˆ¶
              make_api_request() {
                local url="$1"
                local max_retries=5
                local retry_count=0
                local backoff_base=3
                local response

                while [[ $retry_count -lt $max_retries ]]; do
                  # åœ¨æ¯æ¬¡è¯·æ±‚å‰æ£€æŸ¥é€Ÿç‡é™åˆ¶
                  if ! check_and_handle_rate_limit 10; then
                    echo "âŒ APIé€Ÿç‡é™åˆ¶æ£€æŸ¥å¤±è´¥ï¼Œç»ˆæ­¢è¯·æ±‚" >&2
                    return 1
                  fi

                  echo "ğŸ“¡ å‘èµ·APIè¯·æ±‚ (å°è¯• $((retry_count + 1))/$max_retries): $url" >&2
                  response=$(curl -s -w "HTTP_CODE:%{http_code}" \
                    -H "Authorization: token $GITHUB_TOKEN" "$url")

                  local http_code
                  http_code=$(echo "$response" | grep -o "HTTP_CODE:[0-9]*" | cut -d: -f2)
                  local body
                  body=$(echo "$response" | sed 's/HTTP_CODE:[0-9]*$//')

                  # æ ¹æ®HTTPçŠ¶æ€ç åˆ¤æ–­æ˜¯å¦éœ€è¦é‡è¯•
                  case "$http_code" in
                    200)
                      # æˆåŠŸå“åº”ï¼Œæ£€æŸ¥å†…å®¹æ˜¯å¦æœ‰æ•ˆ
                      if [[ -n "$body" && "$body" != *"rate limit"* && \
                            "$body" != *"Not Found"* ]]; then
                        echo "$body"
                        return 0
                      fi
                      ;;
                    403)
                      # å¯èƒ½æ˜¯é€Ÿç‡é™åˆ¶ï¼Œç­‰å¾…æ›´é•¿æ—¶é—´
                      echo "âš ï¸  æ”¶åˆ°403å“åº”ï¼Œå¯èƒ½è§¦å‘é€Ÿç‡é™åˆ¶" >&2
                      if ! check_and_handle_rate_limit 5; then
                        return 1
                      fi
                      ;;
                    404)
                      # èµ„æºä¸å­˜åœ¨ï¼Œä¸éœ€è¦é‡è¯•
                      echo "âŒ èµ„æºä¸å­˜åœ¨ (404): $url" >&2
                      return 1
                      ;;
                    301|302)
                      # é‡å®šå‘ï¼Œå°è¯•è·å–æ–°ä½ç½®
                      echo "ğŸ”„ æ£€æµ‹åˆ°é‡å®šå‘ ($http_code)" >&2
                      ;;
                    *)
                      echo "âš ï¸  æ”¶åˆ°æ„å¤–HTTPçŠ¶æ€ç : $http_code" >&2
                      ;;
                  esac

                  retry_count=$((retry_count + 1))
                  if [[ $retry_count -lt $max_retries ]]; then
                    local wait_time
                    wait_time=$((backoff_base ** retry_count))
                    echo "â³ è¯·æ±‚å¤±è´¥ï¼ŒæŒ‡æ•°é€€é¿ç­‰å¾… $wait_time ç§’åé‡è¯•..." >&2
                    sleep $wait_time
                  fi
                done

                echo "âŒ APIè¯·æ±‚æœ€ç»ˆå¤±è´¥ï¼Œå·²è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°" >&2
                return 1
              }

              # ä½¿ç”¨æ™ºèƒ½è¯·æ±‚æœºåˆ¶è·å–æœ€æ–°ç‰ˆæœ¬
              latest_release=$(make_api_request \
                "https://api.github.com/repos/$owner_repo/releases/latest")

              if [[ -z "$latest_release" || "$latest_release" == *"rate limit"* || \
                    "$latest_release" == *"Not Found"* ]]; then
                echo "âŒ GitHub API è¯·æ±‚å¤±è´¥æˆ–è¾¾åˆ°é€Ÿç‡é™åˆ¶ $cask_file (ä»“åº“: $owner_repo)" >&2
                return
              fi

              latest_version=$(echo "$latest_release" | jq -r '.tag_name' | sed 's/^v//')

              if [[ "$latest_version" == "null" || -z "$latest_version" ]]; then
                echo "âŒ è·å– $cask_file æœ€æ–°ç‰ˆæœ¬å¤±è´¥ (ä»“åº“: $owner_repo)" >&2
                echo "API å“åº”: $(echo "$latest_release" | jq -r '.message // "æ— æ¶ˆæ¯"')" >&2

                # å¦‚æœæ˜¯ hiddifyï¼Œå°è¯•ä½¿ç”¨æ–°çš„ä»“åº“å
                if [[ "$owner_repo" == *"hiddify"* && "$owner_repo" == *"hiddify-next"* ]]; then
                  echo "ğŸ”„ å°è¯• hiddify çš„å¤‡ç”¨ä»“åº“å..." >&2
                  owner_repo="hiddify/hiddify-app"
                  latest_release=$(curl -s \
                    "https://api.github.com/repos/$owner_repo/releases/latest")
                  latest_version=$(echo "$latest_release" | jq -r '.tag_name' | sed 's/^v//')

                  if [[ "$latest_version" != "null" && -n "$latest_version" ]]; then
                    echo "âœ… åœ¨å¤‡ç”¨ä»“åº“ä¸­æ‰¾åˆ°ç‰ˆæœ¬: $owner_repo" >&2
                  else
                    echo "âŒ å¤‡ç”¨ä»“åº“ä¹Ÿå¤±è´¥äº†" >&2
                    return
                  fi
                else
                  return
                fi
              fi

              echo "æ‰¾åˆ°æœ€æ–°ç‰ˆæœ¬: $latest_version"

              # è·å–åŒ¹é…çš„èµ„æºæ–‡ä»¶
               echo "æœç´¢åŒ¹é…æ¨¡å¼çš„èµ„äº§: $asset_pattern"

               # åˆ—å‡ºæ‰€æœ‰å¯ç”¨çš„èµ„æºæ–‡ä»¶ç”¨äºè°ƒè¯•
               echo "å¯ç”¨èµ„äº§:"
               echo "$latest_release" | jq -r '.assets[].name' | sed 's/^/  - /'

               # é€šç”¨çš„èµ„æºæ–‡ä»¶åŒ¹é…é€»è¾‘
               # é¦–å…ˆå°è¯•å®Œå…¨åŒ¹é…æ¨¡å¼ï¼ˆä¿®å¤ jq è½¬ä¹‰é—®é¢˜ï¼‰
               # å¯¹äºå›ºå®šæ–‡ä»¶åï¼ˆå¦‚ Hiddify-MacOS.dmgï¼‰ï¼Œä½¿ç”¨ç²¾ç¡®åŒ¹é…
               if [[ "$asset_pattern" =~ ^[A-Za-z0-9._-]+\\\.[a-z]+$ ]]; then
                 # å›ºå®šæ–‡ä»¶åï¼Œä½¿ç”¨ç²¾ç¡®åŒ¹é…
                 fixed_name=${asset_pattern//\\./.}
                 download_url=$(echo "$latest_release" | \
                   jq -r ".assets[] | select(.name == \"$fixed_name\") | .browser_download_url" | head -1)
                 echo "ğŸ¯ å¯¹å›ºå®šæ–‡ä»¶åä½¿ç”¨ç²¾ç¡®åŒ¹é…: $fixed_name"
               else
                 # ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…
                 echo "ğŸ¯ ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…: $asset_pattern" >&2
                 download_url=$(echo "$latest_release" | \
                   jq -r ".assets[] | select(.name | test(\"$asset_pattern\")) | .browser_download_url" | head -1)

                 # å¦‚æœæ­£åˆ™åŒ¹é…å¤±è´¥ï¼Œå°è¯•æ›´ç®€å•çš„æ¨¡å¼
                 if [[ -z "$download_url" || "$download_url" == "null" ]]; then
                   echo "ğŸ”„ æ­£åˆ™åŒ¹é…å¤±è´¥ï¼Œå°è¯•ç®€åŒ–æ¨¡å¼..." >&2
                   # ç§»é™¤å¤æ‚çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œä½¿ç”¨æ›´ç®€å•çš„åŒ¹é…
                   simple_pattern=$(echo "$asset_pattern" | sed -E 's/\\\././g' | \
                     sed -E 's/\[0-9\]\+\\\.[0-9\]\+\\\.[0-9\]\+/[0-9.]*/g' | \
                     sed -E 's/\([^)]*\)/*/g')
                   echo "ğŸ¯ ç®€åŒ–åçš„æ¨¡å¼: $simple_pattern" >&2
                   download_url=$(echo "$latest_release" | \
                     jq -r ".assets[] | select(.name | contains(\"$simple_pattern\")) | .browser_download_url" | \
                     head -1)
                 fi
               fi

               # å¦‚æœæ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„èµ„æºï¼Œå°è¯•æ™ºèƒ½åŒ¹é…
                if [[ -z "$download_url" || "$download_url" == "null" ]]; then
                  echo "æœªæ‰¾åˆ°ç²¾ç¡®åŒ¹é…ï¼Œå°è¯•æ™ºèƒ½åŒ¹é…..."

                  # ä»åŸå§‹æ–‡ä»¶åä¸­æå–åŸºæœ¬ä¿¡æ¯
                  local base_name
                  base_name=$(basename "$cask_file" .rb)
                  local file_ext=""

                  # ä» asset_pattern ä¸­æ¨æ–­æ–‡ä»¶æ‰©å±•å
                  if [[ "$asset_pattern" == *".dmg"* ]]; then
                    file_ext="dmg"
                  elif [[ "$asset_pattern" == *".zip"* ]]; then
                    file_ext="zip"
                  elif [[ "$asset_pattern" == *".pkg"* ]]; then
                    file_ext="pkg"
                  else
                    file_ext="(dmg|zip|pkg)"
                  fi

                  echo "å°è¯•æ™ºèƒ½åŒ¹é… base_name: $base_name, file_ext: $file_ext"

                  # ç‰¹æ®Šå¤„ç†ï¼šclash-nyanpasu çš„æ–‡ä»¶åæ¨¡å¼
                    if [[ "$base_name" == "clash-nyanpasu" ]]; then
                      echo "ğŸ¯ clash-nyanpasu ç‰¹æ®Šå¤„ç†..."
                      # å°è¯•åŒ¹é… Clash.Nyanpasu_ç‰ˆæœ¬_æ¶æ„.dmg æ ¼å¼ï¼ˆä¿®å¤è½¬ä¹‰é—®é¢˜ï¼‰
                      download_url=$(echo "$latest_release" | \
                        jq -r '.assets[] | select(.name | test("Clash[.]Nyanpasu_.*[.](dmg|zip|pkg)"; "i")) | \
                          .browser_download_url' | \
                        head -1)

                      if [[ -n "$download_url" && "$download_url" != "null" ]]; then
                        echo "âœ… æ‰¾åˆ° clash-nyanpasu èµ„äº§: $(echo "$latest_release" | \
                          jq -r ".assets[] | select(.browser_download_url == \"$download_url\") | \
                            .name")"
                      fi
                    fi

                    # ç‰¹æ®Šå¤„ç†ï¼šhiddify çš„æ–‡ä»¶åæ¨¡å¼
                    if [[ "$base_name" == "hiddify" && (-z "$download_url" || "$download_url" == "null") ]]; then
                      echo "ğŸ¯ hiddify ç‰¹æ®Šå¤„ç†..."
                      # ç›´æ¥åŒ¹é… Hiddify-MacOS.dmg
                      download_url=$(echo "$latest_release" | \
                        jq -r '.assets[] | select(.name == "Hiddify-MacOS.dmg") | .browser_download_url' | \
                        head -1)

                      if [[ -n "$download_url" && "$download_url" != "null" ]]; then
                        echo "âœ… æ‰¾åˆ° hiddify èµ„äº§: Hiddify-MacOS.dmg"
                      fi
                    fi

                  # å¦‚æœç‰¹æ®Šå¤„ç†æ²¡æœ‰æ‰¾åˆ°ï¼Œç»§ç»­é€šç”¨ç­–ç•¥
                  if [[ -z "$download_url" || "$download_url" == "null" ]]; then
                    # ç­–ç•¥1ï¼šä¼˜å…ˆé€‰æ‹© Apple Silicon (aarch64/arm64) ç‰ˆæœ¬ï¼ˆä¿®å¤è½¬ä¹‰é—®é¢˜ï¼‰
                     download_url=$(echo "$latest_release" | \
                       jq -r '.assets[] | select(.name | test(".*_(aarch64|arm64)[.](dmg|zip|pkg)"; "i")) | \
                         .browser_download_url' | \
                       head -1)

                     if [[ -z "$download_url" || "$download_url" == "null" ]]; then
                       # ç­–ç•¥2ï¼šå°è¯• x64 ç‰ˆæœ¬
                       download_url=$(echo "$latest_release" | \
                         jq -r '.assets[] | select(.name | test(".*_(x64|x86_64)[.](dmg|zip|pkg)"; "i")) | \
                           .browser_download_url' | \
                         head -1)
                     fi

                     if [[ -z "$download_url" || "$download_url" == "null" ]]; then
                       # ç­–ç•¥3ï¼šåŒ¹é…åŒ…å« macOS å…³é”®è¯çš„æ–‡ä»¶
                       download_url=$(echo "$latest_release" | \
                         jq -r '.assets[] | select(.name | test(".*[Mm]ac[Oo][Ss].*[.](dmg|zip|pkg)"; "i")) | \
                           .browser_download_url' | \
                         head -1)
                     fi

                     if [[ -z "$download_url" || "$download_url" == "null" ]]; then
                       # ç­–ç•¥4ï¼šåŒ¹é…åŒ…å«åº”ç”¨åç§°çš„æ–‡ä»¶
                       local app_name_pattern
                       app_name_pattern=$(echo "$base_name" | sed -E 's/-/_/g' | \
                         sed -E 's/([a-z])([A-Z])/\1[_-]?\2/g')
                       download_url=$(echo "$latest_release" | \
                         jq -r ".assets[] | select(.name | test(\".*$app_name_pattern.*[.](dmg|zip|pkg)\"; \"i\")) | \
                           .browser_download_url" | \
                         head -1)
                     fi

                     if [[ -z "$download_url" || "$download_url" == "null" ]]; then
                       # ç­–ç•¥5ï¼šæœ€åå°è¯•åŒ¹é…ä»»ä½• macOS å…¼å®¹çš„æ–‡ä»¶
                       download_url=$(echo "$latest_release" | \
                         jq -r '.assets[] | select(.name | test("[.](dmg|zip|pkg)$"; "i")) | \
                           .browser_download_url' | \
                         head -1)
                     fi

                    if [[ -n "$download_url" && "$download_url" != "null" ]]; then
                      echo "âœ… ä½¿ç”¨æ™ºèƒ½åŒ¹é…æ‰¾åˆ°èµ„äº§: $(echo "$latest_release" | \
                        jq -r ".assets[] | select(.browser_download_url == \"$download_url\") | .name")"
                    fi
                  fi
                fi

              if [[ -n "$download_url" && "$download_url" != "null" ]]; then
                local matched_asset
                 matched_asset=$(echo "$latest_release" | \
                   jq -r ".assets[] | select(.browser_download_url == \"$download_url\") | .name")
                echo "âœ… æ‰¾åˆ°åŒ¹é…çš„èµ„äº§: $matched_asset"
                echo "ğŸ“¥ ä¸‹è½½é“¾æ¥: $download_url"

                # è·å–å½“å‰ç‰ˆæœ¬è¿›è¡Œæ¯”è¾ƒ
                current_version=$(grep -E '^\s*version\s+"' "$cask_file" | sed -E 's/.*version\s+"([^"]+)".*/\1/')

                if [[ "$current_version" == "$latest_version" ]]; then
                  echo "â„¹ï¸  $cask_file å·²æ˜¯æœ€æ–°ç‰ˆæœ¬ (ç‰ˆæœ¬ $current_version)"
                else
                  echo "ğŸ“¥ æ­£åœ¨ä¸‹è½½å¹¶è®¡ç®— SHA256: $download_url..."

                  # ä½¿ç”¨æ›´å¥å£®çš„ä¸‹è½½å’Œ SHA256 è®¡ç®—æ–¹æ³•
                  sha256=$(curl -sL --fail "$download_url" | \
                    shasum -a 256 | awk '{print $1}')

                  if [[ -n "$sha256" && ${#sha256} -eq 64 ]]; then
                    echo "ğŸ”’ è®¡ç®—çš„ SHA256: $sha256"

                    # æ£€æŸ¥æ˜¯å¦ä¸ºå¤šæ¶æ„ caskï¼ˆåŒ…å« arch å˜é‡ï¼‰
                    if grep -q 'arch arm:' "$cask_file"; then
                      echo "ğŸ—ï¸  æ£€æµ‹åˆ°å¤šæ¶æ„ caskï¼Œæ­£åœ¨é€‚å½“æ›´æ–°..."

                      # å¯¹äºå¤šæ¶æ„ caskï¼Œéœ€è¦æ›´æ–°å¯¹åº”æ¶æ„çš„ SHA256
                      if [[ "$download_url" == *"aarch64"* || "$download_url" == *"arm64"* ]]; then
                        # æ›´æ–° ARM æ¶æ„çš„ SHA256
                        sed -i "s/version \".*\"/version \"$latest_version\"/" "$cask_file"
                        sed -i "s/sha256 arm:\s*\"[^\"]*\"/sha256 arm:   \"$sha256\"/" "$cask_file"
                        echo "âœ… å·²æ›´æ–° $cask_file çš„ ARM SHA256 åˆ°ç‰ˆæœ¬ $latest_version"
                      elif [[ "$download_url" == *"x64"* || "$download_url" == *"x86_64"* ]]; then
                        # æ›´æ–° Intel æ¶æ„çš„ SHA256
                        sed -i "s/version \".*\"/version \"$latest_version\"/" "$cask_file"
                        sed -i \
                          "s/sha256.*intel:\s*\"[^\"]*\"/sha256 arm:   \"$sha256\",\n         intel: \"$sha256\"/" \
                          "$cask_file"
                        echo "âœ… å·²æ›´æ–° $cask_file çš„ Intel SHA256 åˆ°ç‰ˆæœ¬ $latest_version"
                      fi
                    else
                      # å•æ¶æ„ cask çš„æ ‡å‡†æ›´æ–°
                      sed -i "s/version \".*\"/version \"$latest_version\"/" "$cask_file"
                      sed -i "s/sha256 \".*\"/sha256 \"$sha256\"/" "$cask_file"
                      echo "âœ… å·²æ›´æ–° $cask_file åˆ°ç‰ˆæœ¬ $latest_version"
                    fi

                    echo "ğŸ“ å¯¹ $cask_file çš„æ›´æ”¹:"
                    echo "   ç‰ˆæœ¬: $current_version â†’ $latest_version"
                    echo "   èµ„äº§: $matched_asset"
                  else
                    echo "âŒ è®¡ç®— $cask_file çš„æœ‰æ•ˆ SHA256 å¤±è´¥ (å¾—åˆ°: $sha256)"
                  fi
                fi
              else
                echo "âŒ æœªæ‰¾åˆ° $cask_file çš„åŒ¹é…èµ„äº§"
                echo "   ä½¿ç”¨çš„æ¨¡å¼: $asset_pattern"
                echo "   ä»“åº“: $repo_url"
                echo "   åŸºç¡€åç§°: $base_name"
                echo "   å¯ç”¨èµ„äº§:"
                echo "$latest_release" | jq -r '.assets[].name' | sed 's/^/     - /'

                # å°è¯•æœ€åçš„é€šç”¨åŒ¹é…ç­–ç•¥
                echo "ğŸ”„ å°è¯•æœ€ç»ˆå›é€€åŒ¹é…..."
                # åŒ¹é…ä»»ä½•åŒ…å«åº”ç”¨åç§°çš„ macOS æ–‡ä»¶
                fallback_url=$(echo "$latest_release" | \
                  jq -r ".assets[] | select(.name | test(\".*$base_name.*[.](dmg|zip|pkg)\"; \"i\")) | \
                    .browser_download_url" | \
                  head -1)

                if [[ -n "$fallback_url" && "$fallback_url" != "null" ]]; then
                  download_url="$fallback_url"
                  matched_asset=$(echo "$latest_release" | \
                    jq -r ".assets[] | select(.browser_download_url == \"$download_url\") | .name")
                  echo "âœ… æ‰¾åˆ°å›é€€åŒ¹é…: $matched_asset"
                  echo "ğŸ“¥ å›é€€ä¸‹è½½é“¾æ¥: $download_url"

                  # é‡æ–°æ‰§è¡Œä¸‹è½½å’Œæ›´æ–°é€»è¾‘
                  current_version=$(grep -E '^\s*version\s+"' "$cask_file" | \
                    sed -E 's/.*version\s+"([^"]+)".*/\1/')

                  if [[ "$current_version" != "$latest_version" ]]; then
                    echo "ğŸ“¥ æ­£åœ¨ä¸‹è½½å¹¶è®¡ç®—å›é€€é“¾æ¥çš„ SHA256..."
                    sha256=$(curl -sL --fail "$download_url" | \
                      shasum -a 256 | awk '{print $1}')

                    if [[ -n "$sha256" && ${#sha256} -eq 64 ]]; then
                      echo "ğŸ”’ è®¡ç®—çš„ SHA256: $sha256"
                      sed -i "s/version \".*\"/version \"$latest_version\"/" "$cask_file"
                      sed -i "s/sha256 \".*\"/sha256 \"$sha256\"/" "$cask_file"
                      echo "âœ… ä½¿ç”¨å›é€€æ–¹å¼å·²æ›´æ–° $cask_file åˆ°ç‰ˆæœ¬ $latest_version"
                      echo "ğŸ“ å¯¹ $cask_file çš„æ›´æ”¹:"
                      echo "   ç‰ˆæœ¬: $current_version â†’ $latest_version"
                      echo "   èµ„äº§: $matched_asset"
                    else
                      echo "âŒ è®¡ç®—å›é€€é“¾æ¥çš„æœ‰æ•ˆ SHA256 å¤±è´¥ (å¾—åˆ°: $sha256)"
                    fi
                  fi
                else
                  echo "âŒ ä¹Ÿæœªæ‰¾åˆ°å›é€€åŒ¹é…"
                fi
              fi
            else
              echo "âš ï¸  è·³è¿‡ $cask_file (ä¸æ˜¯ GitHub ä»“åº“æˆ–ç¼ºå°‘èµ„äº§æ¨¡å¼)"
            fi
            echo "---"
          }

          # ğŸ” å‘ç°å¹¶å¤„ç†æ‰€æœ‰ cask æ–‡ä»¶
          echo "ğŸ” åœ¨ Casks/ ç›®å½•ä¸­å‘ç° cask æ–‡ä»¶..."

          # åˆ›å»ºä¸´æ—¶ç›®å½•ç”¨äºå¹¶è¡Œå¤„ç†
          temp_dir=$(mktemp -d)
          trap "rm -rf $temp_dir" EXIT

          # æ”¶é›†æ‰€æœ‰éœ€è¦å¤„ç†çš„caskæ–‡ä»¶
          cask_files=()
          for cask_file in Casks/*.rb; do
            if [[ -f "$cask_file" ]]; then
              cask_files+=("$cask_file")
            fi
          done

          echo "ğŸ“¦ å‘ç° ${#cask_files[@]} ä¸ª cask æ–‡ä»¶"

          # æ‰¹é‡å¤„ç†å‡½æ•°
          process_cask_batch() {
            local batch_files=("$@")
            local batch_size=${#batch_files[@]}

            echo "ğŸ”„ å¼€å§‹å¤„ç†æ‰¹æ¬¡ï¼ŒåŒ…å« $batch_size ä¸ªæ–‡ä»¶"

            for cask_file in "${batch_files[@]}"; do
              echo "ğŸ“¦ å¤„ç† cask æ–‡ä»¶: $cask_file"

              # æå–ä»“åº“ä¿¡æ¯å’Œèµ„æºæ¨¡å¼
              repo_info=$(extract_repo_info "$cask_file")
              repo_url=$(echo "$repo_info" | cut -d'|' -f1)
              asset_pattern=$(echo "$repo_info" | cut -d'|' -f2)

              echo "ğŸ”— ä»“åº“: $repo_url"
              echo "ğŸ¯ èµ„äº§æ¨¡å¼: $asset_pattern"

              # è°ƒè¯•ï¼šæ£€æŸ¥æå–çš„ä¿¡æ¯
              if [[ -z "$repo_url" || -z "$asset_pattern" ]]; then
                echo "âš ï¸  è­¦å‘Š: ä»“åº“ URL æˆ–èµ„äº§æ¨¡å¼ä¸ºç©º" >&2
                echo "   repo_info: '$repo_info'" >&2
                echo "   repo_url: '$repo_url'" >&2
                echo "   asset_pattern: '$asset_pattern'" >&2
              fi

              # æ£€æŸ¥èµ„äº§æ¨¡å¼æ˜¯å¦è¢«æˆªæ–­
              if [[ ${#asset_pattern} -lt 10 ]]; then
                echo "âš ï¸  è­¦å‘Š: èµ„äº§æ¨¡å¼ä¼¼ä¹å¤ªçŸ­ (${#asset_pattern} å­—ç¬¦): '$asset_pattern'" >&2
                echo "ğŸ” é‡æ–°æå–èµ„äº§æ¨¡å¼å¹¶æ˜¾ç¤ºè¯¦ç»†è¾“å‡º..." >&2

                # é‡æ–°æå–å¹¶æ˜¾ç¤ºè¯¦ç»†è¿‡ç¨‹
                url_template=$(grep -E '^\s*url\s+' "$cask_file" | head -1)
                echo "æ‰¾åˆ° URL æ¨¡æ¿: $url_template" >&2

                filename_template=$(echo "$url_template" | sed -E 's/.*\/([^"]+)".*/\1/' | sed -E 's/#{[^}]+}/*/g')
                echo "æ–‡ä»¶åæ¨¡æ¿: $filename_template" >&2

                # é‡æ–°ç”Ÿæˆèµ„äº§æ¨¡å¼
                asset_pattern=$(echo "$filename_template" | \
                  sed -E 's/\./\\./g' | sed -E 's/\*/[^/]+/g')
                echo "é‡æ–°ç”Ÿæˆçš„èµ„äº§æ¨¡å¼: $asset_pattern" >&2
              fi

              # æ›´æ–° cask
              update_cask "$cask_file" "$repo_url" "$asset_pattern"

              # åœ¨å¤„ç†é—´éš”ä¸­æ·»åŠ çŸ­æš‚å»¶è¿Ÿï¼Œé¿å…APIè¿‡è½½
              sleep 1
            done
          }

          # åˆ†æ‰¹å¤„ç†ï¼Œæ¯æ‰¹3ä¸ªæ–‡ä»¶ï¼Œé¿å…APIé€Ÿç‡é™åˆ¶
          batch_size=3
          total_files=${#cask_files[@]}

          for ((i=0; i<total_files; i+=batch_size)); do
            batch=("${cask_files[@]:i:batch_size}")
            batch_num=$((i/batch_size + 1))
            total_batches=$(((total_files + batch_size - 1) / batch_size))

            echo "ğŸ“Š å¤„ç†æ‰¹æ¬¡ $batch_num/$total_batches (æ–‡ä»¶ $((i+1))-$((i+${#batch[@]}))/$total_files)"

            process_cask_batch "${batch[@]}"

            # æ‰¹æ¬¡é—´ç­‰å¾…ï¼Œç¡®ä¿APIé€Ÿç‡é™åˆ¶ä¸è¢«è§¦å‘
            if [[ $i -lt $((total_files - batch_size)) ]]; then
              echo "â³ æ‰¹æ¬¡é—´ç­‰å¾… 10 ç§’ï¼Œé¿å…APIé€Ÿç‡é™åˆ¶..."
              sleep 10
            fi
          done

          echo "ğŸ‰ æ‰€æœ‰ cask æ–‡ä»¶å·²å¤„ç†å®Œæˆ!"

      - name: Commit and push changes
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git add Casks/

          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹éœ€è¦æäº¤
          if ! git diff --quiet || ! git diff --staged --quiet; then
            # è·å–å·²æ›´æ”¹çš„ cask æ–‡ä»¶åˆ—è¡¨
            changed_casks=$(git diff --cached --name-only | grep 'Casks/.*\.rb$' | \
              sed 's|Casks/||' | sed 's|\.rb$||' | tr '\n' ' ' | sed 's/ $//')

            if [[ -n "$changed_casks" ]]; then
              # ä¸ºæ¯ä¸ªæ›´æ”¹çš„ cask è·å–æ–°ç‰ˆæœ¬ä¿¡æ¯
              commit_details=""
              for cask in $changed_casks; do
                cask_file="Casks/${cask}.rb"
                if [[ -f "$cask_file" ]]; then
                  new_version=$(grep -E '^\s*version\s+' "$cask_file" | head -1 | \
                    sed -E 's/.*version\s+"([^"]+)".*/\1/')
                  if [[ -n "$new_version" ]]; then
                    commit_details="${commit_details}\n- ${cask}: æ›´æ–°åˆ° v${new_version}"
                  else
                    commit_details="${commit_details}\n- ${cask}: å·²æ›´æ–°"
                  fi
                fi
              done

              # æ„å»ºè¯¦ç»†çš„æäº¤ä¿¡æ¯
              commit_message="ğŸš€ æ›´æ–° Homebrew Casks

              æœ¬æ¬¡æ›´æ–°åŒ…å«ä»¥ä¸‹åº”ç”¨:${commit_details}

              ğŸ“… æ›´æ–°æ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')
              ğŸ¤– è‡ªåŠ¨æ›´æ–° by GitHub Actions"

              git commit -m "$commit_message"
              echo "âœ… å·²æäº¤æ›´æ”¹ï¼ŒåŒ…å«ä»¥ä¸‹åº”ç”¨æ›´æ–°: $changed_casks"
            else
              git commit -m "ğŸ”§ æ›´æ–° Homebrew Casks é…ç½®æ–‡ä»¶"
              echo "âœ… å·²æäº¤é…ç½®æ–‡ä»¶æ›´æ”¹"
            fi

            # åªåœ¨æœ‰æäº¤æ—¶æ‰æ¨é€
            echo "ğŸ“¤ æ­£åœ¨æ¨é€æ›´æ”¹åˆ°è¿œç¨‹ä»“åº“..."
            git pull --rebase origin main || {
              echo "âš ï¸  æ‹‰å–è¿œç¨‹æ›´æ”¹å¤±è´¥ï¼Œå°è¯•å¼ºåˆ¶æ¨é€..."
              git push --force-with-lease
            } && git push
            echo "âœ… æ›´æ”¹å·²æˆåŠŸæ¨é€åˆ°è¿œç¨‹ä»“åº“"
          else
            echo "â„¹ï¸  æ²¡æœ‰æ£€æµ‹åˆ°éœ€è¦æäº¤çš„æ›´æ”¹ï¼Œè·³è¿‡æ¨é€æ“ä½œ"
          fi
