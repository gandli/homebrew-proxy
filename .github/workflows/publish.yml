---
name: Brew PR Pull

'on':
  pull_request_target:
    types:
      - labeled

# é˜²æ­¢å¹¶å‘æ‰§è¡Œï¼Œé¿å…å†²çª
concurrency:
  group: pr-pull-${{ github.event.pull_request.number }}
  cancel-in-progress: false

jobs:
  pr-pull:
    if: contains(github.event.pull_request.labels.*.name, 'pr-pull')
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    permissions:
      actions: read
      checks: read
      contents: write
      issues: read
      pull-requests: write
      # æœ€å°æƒé™åŸåˆ™ - åªæˆäºˆå¿…è¦çš„æƒé™
    steps:
      - name: æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0

      - name: éªŒè¯ PR å®‰å…¨æ€§
        run: |
          echo "ğŸ” æ­£åœ¨éªŒè¯ PR å®‰å…¨æ€§..."

          # æ£€æŸ¥ PR æ˜¯å¦åªä¿®æ”¹äº† Casks ç›®å½•
          changed_files=$(git diff --name-only origin/main...HEAD)
          echo "ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶:"
          echo "$changed_files"

          # éªŒè¯åªä¿®æ”¹äº†å…è®¸çš„æ–‡ä»¶ç±»å‹
          if echo "$changed_files" | grep -v -E '^(Casks/.*\.rb|README\.md)$' | grep -q .; then
            echo "âŒ æ£€æµ‹åˆ°ä¸å…è®¸çš„æ–‡ä»¶ä¿®æ”¹ï¼Œä»…å…è®¸ä¿®æ”¹ Casks/*.rb å’Œ README.md"
            echo "ä¸å…è®¸çš„æ–‡ä»¶:"
            echo "$changed_files" | grep -v -E '^(Casks/.*\.rb|README\.md)$'
            exit 1
          fi

          # æ£€æŸ¥æ˜¯å¦åŒ…å«æ•æ„Ÿä¿¡æ¯
          echo "ğŸ” æ£€æŸ¥æ•æ„Ÿä¿¡æ¯..."
          if git diff origin/main...HEAD | grep -iE '(password|secret|token|api_key|private_key)'; then
            echo "âŒ æ£€æµ‹åˆ°å¯èƒ½çš„æ•æ„Ÿä¿¡æ¯æ³„éœ²"
            exit 1
          fi

          # æ£€æŸ¥æ–‡ä»¶å¤§å°
          echo "ğŸ“ æ£€æŸ¥æ–‡ä»¶å¤§å°..."
          for file in $changed_files; do
            file_size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null || echo 0)
            if [[ -f "$file" && $file_size -gt 10240 ]]; then
              echo "âš ï¸ æ–‡ä»¶ $file è¿‡å¤§ (>10KB)ï¼Œè¯·æ£€æŸ¥æ˜¯å¦åŒ…å«ä¸å¿…è¦çš„å†…å®¹"
            fi
          done

          echo "âœ… PR å®‰å…¨æ€§éªŒè¯é€šè¿‡"

      - name: Cache Homebrew
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/Homebrew
            /home/linuxbrew/.linuxbrew/var/homebrew/locks
            /home/linuxbrew/.linuxbrew/Library/Taps
          key: homebrew-${{ runner.os }}-${{ hashFiles('Casks/*.rb') }}
          restore-keys: |
            homebrew-${{ runner.os }}-

      - name: è®¾ç½® Homebrew ç¯å¢ƒ
        uses: Homebrew/actions/setup-homebrew@main
        with:
          token: ${{ secrets.GH_TOKEN }}
        env:
          HOMEBREW_NO_ANALYTICS: 1
          HOMEBREW_NO_AUTO_UPDATE: 1
          HOMEBREW_NO_INSECURE_REDIRECT: 1

      - name: é…ç½® Git ç”¨æˆ·ä¿¡æ¯
        uses: Homebrew/actions/git-user-config@main

      - name: æ‹‰å–é¢„ç¼–è¯‘åŒ… (bottles)
        env:
          HOMEBREW_GITHUB_API_TOKEN: ${{ secrets.GH_TOKEN }}
          PULL_REQUEST: ${{ github.event.pull_request.number }}
        run: |
          echo "ğŸ“¦ æ­£åœ¨æ‹‰å– PR #$PULL_REQUEST çš„é¢„ç¼–è¯‘åŒ…..."
          set -e

          # æ‰§è¡Œ brew pr-pull å‘½ä»¤
          if brew pr-pull --debug --tap="$GITHUB_REPOSITORY" "$PULL_REQUEST"; then
            echo "âœ… é¢„ç¼–è¯‘åŒ…æ‹‰å–æˆåŠŸ"
          else
            echo "âŒ é¢„ç¼–è¯‘åŒ…æ‹‰å–å¤±è´¥"
            exit 1
          fi

      - name: æ¨é€æäº¤åˆ°ä¸»åˆ†æ”¯
        uses: Homebrew/actions/git-try-push@main
        with:
          branch: main
        id: push_commits

      - name: éªŒè¯æ¨é€ç»“æœ
        run: |
          echo "ğŸ” éªŒè¯æ¨é€ç»“æœ..."
          if git log --oneline -1; then
            echo "âœ… æäº¤å·²æˆåŠŸæ¨é€åˆ°ä¸»åˆ†æ”¯"
          else
            echo "âŒ æ¨é€éªŒè¯å¤±è´¥"
            exit 1
          fi

      - name: åˆ é™¤åŠŸèƒ½åˆ†æ”¯
        if: github.event.pull_request.head.repo.fork == false && steps.push_commits.outcome == 'success'
        env:
          BRANCH: ${{ github.event.pull_request.head.ref }}
        run: |
          echo "ğŸ—‘ï¸ æ­£åœ¨åˆ é™¤åˆ†æ”¯: $BRANCH"
          if git push --delete origin "$BRANCH"; then
            echo "âœ… åˆ†æ”¯ $BRANCH å·²æˆåŠŸåˆ é™¤"
          else
            echo "âš ï¸ åˆ†æ”¯åˆ é™¤å¤±è´¥ï¼Œå¯èƒ½å·²è¢«åˆ é™¤æˆ–ä¸å­˜åœ¨"
          fi

      - name: æ·»åŠ æˆåŠŸè¯„è®º
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸ‰ **PR å‘å¸ƒæˆåŠŸï¼**\n\nâœ… é¢„ç¼–è¯‘åŒ…å·²æˆåŠŸæ‹‰å–å¹¶åˆå¹¶åˆ°ä¸»åˆ†æ”¯\n' +
                'âœ… ç›¸å…³åˆ†æ”¯å·²æ¸…ç†å®Œæˆ\n\næ„Ÿè°¢æ‚¨çš„è´¡çŒ®ï¼'
            });

      - name: æ·»åŠ å¤±è´¥è¯„è®º
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'âŒ **PR å‘å¸ƒå¤±è´¥ï¼**\n\nè¯·æ£€æŸ¥å·¥ä½œæµæ—¥å¿—ä»¥äº†è§£è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚\n\n' +
                'å¯èƒ½çš„åŸå› ï¼š\n- é¢„ç¼–è¯‘åŒ…æ‹‰å–å¤±è´¥\n- æ¨é€å†²çª\n- æƒé™é—®é¢˜\n\n' +
                'è¯·ä¿®å¤é—®é¢˜åé‡æ–°æ·»åŠ  `pr-pull` æ ‡ç­¾ã€‚'
            });
