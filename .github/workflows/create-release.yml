---
name: Create Release

# è§¦å‘æ¡ä»¶ï¼šæ‰‹åŠ¨è§¦å‘ã€æ¯æœˆç¬¬ä¸€å¤©è‡ªåŠ¨è§¦å‘æˆ–å½“ update-casks å·¥ä½œæµå®Œæˆæ—¶è§¦å‘
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'å‘å¸ƒç‰ˆæœ¬å· (ç•™ç©ºåˆ™è‡ªåŠ¨ç”Ÿæˆ)'
        required: false
        type: string
      prerelease:
        description: 'æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬'
        required: false
        type: boolean
        default: false
      force_recreate:
        description: 'å¼ºåˆ¶é‡æ–°åˆ›å»ºå·²å­˜åœ¨çš„ Release'
        required: false
        type: boolean
        default: false
  schedule:
    # æ¯æœˆ1å· UTC æ—¶é—´ 02:00 (åŒ—äº¬æ—¶é—´ 10:00) è‡ªåŠ¨åˆ›å»º release
    - cron: '0 2 1 * *'
  workflow_run:
    # å½“ update-casks å·¥ä½œæµæˆåŠŸå®Œæˆæ—¶è‡ªåŠ¨è§¦å‘
    workflows: ["Update Casks"]
    types:
      - completed
    branches:
      - main

# é˜²æ­¢å¹¶å‘æ‰§è¡Œ
concurrency:
  group: create-release
  cancel-in-progress: false

jobs:
  create-release:
    runs-on: ubuntu-latest
    # åªæœ‰å½“ workflow_run äº‹ä»¶æˆåŠŸå®Œæˆæˆ–è€…æ˜¯å…¶ä»–è§¦å‘æ–¹å¼æ—¶æ‰æ‰§è¡Œ
    if: ${{ github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success' }}
    permissions:
      contents: write
      pull-requests: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œç”¨äºç”Ÿæˆå˜æ›´æ—¥å¿—
      
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
      
      - name: Install dependencies
        run: |
          # ä½¿ç”¨æ›´é«˜æ•ˆçš„åŒ…ç®¡ç†å™¨ç¼“å­˜
          sudo apt-get update -qq
          sudo apt-get install -y jq curl
          
          # éªŒè¯å·¥å…·å®‰è£…
          echo "âœ… å·²å®‰è£…å·¥å…·ç‰ˆæœ¬:"
          echo "- jq: $(jq --version)"
          echo "- curl: $(curl --version | head -1)"
          echo "- gh: $(gh --version | head -1)"
      
      - name: Generate version number
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
            # ç¡®ä¿ç‰ˆæœ¬å·ä»¥ v å¼€å¤´
            if [[ ! "$VERSION" =~ ^v ]]; then
              VERSION="v$VERSION"
            fi
          else
            VERSION="v$(date +%Y.%m.%d)"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ ç”Ÿæˆçš„ç‰ˆæœ¬å·: $VERSION"
      
      - name: Check if release exists
        id: check_release
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          FORCE_RECREATE="${{ github.event.inputs.force_recreate || 'false' }}"
          
          if gh release view "$VERSION" >/dev/null 2>&1; then
            echo "exists=true" >> $GITHUB_OUTPUT
            if [[ "$FORCE_RECREATE" == "true" ]]; then
              echo "ğŸ”„ Release $VERSION å·²å­˜åœ¨ï¼Œä½†å°†è¢«å¼ºåˆ¶é‡æ–°åˆ›å»º"
              echo "should_recreate=true" >> $GITHUB_OUTPUT
              # åˆ é™¤ç°æœ‰ Release
              gh release delete "$VERSION" --yes || true
              # åˆ é™¤å¯¹åº”çš„ Git æ ‡ç­¾
              git tag -d "$VERSION" 2>/dev/null || true
              git push origin --delete "$VERSION" 2>/dev/null || true
            else
              echo "âš ï¸  Release $VERSION å·²å­˜åœ¨"
              echo "should_recreate=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "should_recreate=false" >> $GITHUB_OUTPUT
            echo "âœ… Release $VERSION ä¸å­˜åœ¨ï¼Œå¯ä»¥åˆ›å»º"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract app information
        id: apps
        run: |
          echo "ğŸ“¦ æå–åº”ç”¨ç¨‹åºä¿¡æ¯..."
          
          # åˆ›å»ºåº”ç”¨ä¿¡æ¯è¡¨æ ¼
          APP_TABLE="| åº”ç”¨åç§° | æè¿° | ç‰ˆæœ¬ | å®‰è£…å‘½ä»¤ | ä¸»é¡µ |\n|---------|------|------|----------|------|"
          APP_COUNT=0
          INSTALL_COMMANDS=""
          
          for cask_file in Casks/*.rb; do
            if [ -f "$cask_file" ]; then
              app_name=$(basename "$cask_file" .rb)
              # ä½¿ç”¨æ›´å¥å£®çš„æ­£åˆ™è¡¨è¾¾å¼æå–ä¿¡æ¯
              version=$(grep -E '^\s*version\s+"' "$cask_file" | sed 's/.*"\([^"]*\)".*/\1/' | head -1)
              desc=$(grep -E '^\s*desc\s+"' "$cask_file" | sed 's/.*"\([^"]*\)".*/\1/' | head -1)
              homepage=$(grep -E '^\s*homepage\s+"' "$cask_file" | sed 's/.*"\([^"]*\)".*/\1/' | head -1)
              
              # éªŒè¯æå–çš„ä¿¡æ¯
              if [[ -z "$version" || -z "$desc" || -z "$homepage" ]]; then
                echo "âš ï¸ è­¦å‘Š: $app_name çš„æŸäº›ä¿¡æ¯ç¼ºå¤± (version: $version, desc: $desc, homepage: $homepage)"
              fi
              
              APP_TABLE="$APP_TABLE\n| **$app_name** | $desc | \`$version\` | \`brew install gandli/proxy/$app_name\` | [ğŸ”—]($homepage) |"
              INSTALL_COMMANDS="$INSTALL_COMMANDS\nbrew install --cask $app_name"
              APP_COUNT=$((APP_COUNT + 1))
            fi
          done
          
          # å°†å¤šè¡Œå†…å®¹ä¿å­˜åˆ°æ–‡ä»¶ï¼Œé¿å… GitHub Actions çš„å¤šè¡Œè¾“å‡ºé—®é¢˜
          echo -e "$APP_TABLE" > app_table.txt
          echo -e "$INSTALL_COMMANDS" > install_commands.txt
          
          echo "app_count=$APP_COUNT" >> $GITHUB_OUTPUT
          echo "âœ… æå–äº† $APP_COUNT ä¸ªåº”ç”¨ç¨‹åºçš„ä¿¡æ¯"
      
      - name: Generate release notes
        id: release_notes
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          APP_COUNT="${{ steps.apps.outputs.app_count }}"
          
          cat > release_notes.md << 'EOF'
          # ğŸº Homebrew Proxy Tap Release $VERSION
          
          > ğŸš€ **ç²¾é€‰ macOS ä»£ç†å®¢æˆ·ç«¯é›†åˆ** - ä¸€é”®å®‰è£…ä¼˜è´¨ç½‘ç»œä»£ç†å·¥å…·çš„ Homebrew Tap
          
          ## ğŸ“¦ æœ¬æ¬¡å‘å¸ƒåŒ…å«çš„åº”ç”¨ç¨‹åº
          
          EOF
          
          # æ·»åŠ åº”ç”¨ç¨‹åºè¡¨æ ¼
          cat app_table.txt >> release_notes.md
          
          cat >> release_notes.md << 'EOF'
          
          ## ğŸš€ å¦‚ä½•å®‰è£…è¿™äº›åº”ç”¨ï¼Ÿ
          
          ### æ–¹æ³•ä¸€ï¼šç›´æ¥å®‰è£…
          
          ```bash
          brew install gandli/proxy/<cask_name>
          ```
          
          ### æ–¹æ³•äºŒï¼šå…ˆæ·»åŠ  Tapï¼Œå†å®‰è£…
          
          ```bash
          brew tap gandli/proxy
          brew install --cask <cask_name>
          ```
          
          ### æ–¹æ³•ä¸‰ï¼šä½¿ç”¨ Brewfile
          
          åœ¨ä½ çš„ `Brewfile` ä¸­æ·»åŠ ï¼š
          
          ```ruby
          tap "gandli/proxy"
          cask "<cask_name>"
          ```
          
          ç„¶åè¿è¡Œï¼š
          
          ```bash
          brew bundle
          ```
          
          ## ğŸ“ˆ æ›´æ–°å†…å®¹
          
          - ğŸ“¦ åŒ…å« $APP_COUNT ä¸ªç²¾é€‰ä»£ç†åº”ç”¨ç¨‹åº
          - ğŸ”„ æ‰€æœ‰åº”ç”¨ç¨‹åºç‰ˆæœ¬å·²æ›´æ–°è‡³æœ€æ–°
          - âœ… æ‰€æœ‰ Cask æ–‡ä»¶å·²é€šè¿‡æµ‹è¯•éªŒè¯
          - ğŸ›¡ï¸ ç¡®ä¿æ‰€æœ‰ä¸‹è½½é“¾æ¥å’Œæ ¡éªŒå’Œçš„å®‰å…¨æ€§
          
          ## ğŸ”§ æŠ€æœ¯æ”¹è¿›
          
          - ğŸ¤– è‡ªåŠ¨åŒ– Cask æ›´æ–°æµç¨‹
          - ğŸ“Š æ”¹è¿›çš„ç‰ˆæœ¬æ£€æµ‹æœºåˆ¶
          - ğŸ” å¢å¼ºçš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
          - âš¡ ä¼˜åŒ–çš„æ„å»ºå’Œå‘å¸ƒæµç¨‹
          
          ## ğŸ¤ è´¡çŒ®
          
          æ„Ÿè°¢æ‰€æœ‰ä¸ºæœ¬é¡¹ç›®åšå‡ºè´¡çŒ®çš„å¼€å‘è€…ï¼æ¬¢è¿æäº¤ Pull Request æ¥æ·»åŠ æ–°çš„åº”ç”¨ç¨‹åºæˆ–æ”¹è¿›ç°æœ‰çš„ Cask æ–‡ä»¶ã€‚
          
          ## ğŸ“ æ”¯æŒ
          
          å¦‚æœæ‚¨åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°ä»»ä½•é—®é¢˜ï¼Œè¯·ï¼š
          
          1. æŸ¥çœ‹ [README.md](README.md) ä¸­çš„æ–‡æ¡£
          2. åœ¨ [Issues](https://github.com/gandli/homebrew-proxy/issues) ä¸­æœç´¢ç›¸å…³é—®é¢˜
          3. å¦‚æœé—®é¢˜æœªè§£å†³ï¼Œè¯·åˆ›å»ºæ–°çš„ Issue
          
          ---
          
          **å®‰è£…å‘½ä»¤å¿«é€Ÿå‚è€ƒï¼š**
          
          ```bash
          # æ·»åŠ  Tap
          brew tap gandli/proxy
          
          # å®‰è£…æ‰€æœ‰åº”ç”¨ï¼ˆå¯é€‰ï¼‰
          EOF
          
          # æ·»åŠ å®‰è£…å‘½ä»¤
          cat install_commands.txt >> release_notes.md
          
          echo '```' >> release_notes.md
          
          # æ›¿æ¢å˜é‡
          sed -i "s/\$VERSION/$VERSION/g" release_notes.md
          sed -i "s/\$APP_COUNT/$APP_COUNT/g" release_notes.md
          
          echo "âœ… å‘å¸ƒè¯´æ˜å·²ç”Ÿæˆ"
          
          # æ˜¾ç¤ºå‘å¸ƒè¯´æ˜é¢„è§ˆ
          echo "ğŸ“‹ å‘å¸ƒè¯´æ˜é¢„è§ˆ:"
          echo "----------------------------------------"
          head -20 release_notes.md
          echo "..."
          echo "----------------------------------------"
      
      - name: Download and upload assets
        id: assets
        if: steps.check_release.outputs.exists == 'false' || steps.check_release.outputs.should_recreate == 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          echo "ğŸ“¦ å¼€å§‹ä¸‹è½½åº”ç”¨ç¨‹åºæ–‡ä»¶..."
          
          # åˆ›å»ºä¸‹è½½ç›®å½•
          mkdir -p downloads
          
          # ä¸‹è½½åº”ç”¨ç¨‹åºæ–‡ä»¶çš„å‡½æ•°
          download_app_from_cask() {
            local cask_file="$1"
            local app_name=$(basename "$cask_file" .rb)
            
            echo "ğŸ”„ å¤„ç† $app_name..."
            
            # æå–ç‰ˆæœ¬å·å’Œ URL
            local version=$(grep -E '^\s*version\s+"' "$cask_file" | sed 's/.*"\([^"]*\)".*/\1/' | head -1)
            
            if [[ -z "$version" ]]; then
              echo "âš ï¸ æ— æ³•æå–ç‰ˆæœ¬å·: $app_name"
              return 1
            fi
            
            # æ£€æŸ¥æ˜¯å¦æœ‰å¤šæ¶æ„æ”¯æŒ
            if grep -q "arch arm:" "$cask_file"; then
              # å¤šæ¶æ„åº”ç”¨
              local url_line=$(grep -E '^\s*url\s+"' "$cask_file" | head -1)
              if [[ -n "$url_line" ]]; then
                local base_url=$(echo "$url_line" | sed 's/.*"\([^"]*\)".*/\1/')
                
                # ARM ç‰ˆæœ¬
                local arm_arch=$(grep "arch arm:" "$cask_file" | sed -E 's/.*arch arm: "([^"]+)".*/\1/')
                if [[ -n "$arm_arch" ]]; then
                  local arm_url=$(echo "$base_url" | sed "s/#{version}/$version/g" | sed "s/#{arch}/$arm_arch/g")
                  local arm_filename="${app_name}-${version}-arm64$(echo "$arm_url" | sed 's/.*\(\.[^.]*\)$/\1/')"
                  
                  echo "â¬‡ï¸ ä¸‹è½½ ARM ç‰ˆæœ¬: $arm_filename"
                  if curl -L --fail --max-time 300 -o "downloads/$arm_filename" "$arm_url" 2>/dev/null; then
                    echo "downloads/$arm_filename" >> asset_files.txt
                    echo "âœ… ARM ç‰ˆæœ¬ä¸‹è½½æˆåŠŸ"
                  else
                    echo "âŒ ARM ç‰ˆæœ¬ä¸‹è½½å¤±è´¥"
                  fi
                fi
                
                # Intel ç‰ˆæœ¬
                local intel_arch=$(grep "arch arm:" "$cask_file" | sed -E 's/.*intel: "([^"]+)".*/\1/')
                if [[ -n "$intel_arch" ]]; then
                  local intel_url=$(echo "$base_url" | sed "s/#{version}/$version/g" | sed "s/#{arch}/$intel_arch/g")
                  local intel_filename="${app_name}-${version}-intel$(echo "$intel_url" | sed 's/.*\(\.[^.]*\)$/\1/')"
                  
                  echo "â¬‡ï¸ ä¸‹è½½ Intel ç‰ˆæœ¬: $intel_filename"
                  if curl -L --fail --max-time 300 -o "downloads/$intel_filename" "$intel_url" 2>/dev/null; then
                    echo "downloads/$intel_filename" >> asset_files.txt
                    echo "âœ… Intel ç‰ˆæœ¬ä¸‹è½½æˆåŠŸ"
                  else
                    echo "âŒ Intel ç‰ˆæœ¬ä¸‹è½½å¤±è´¥"
                  fi
                fi
              fi
            else
              # å•ä¸€æ¶æ„åº”ç”¨
              local url=$(grep -E '^\s*url\s+"' "$cask_file" | sed 's/.*"\([^"]*\)".*/\1/' | head -1)
              url=$(echo "$url" | sed "s/#{version}/$version/g")
              
              if [[ -n "$url" ]]; then
                local filename="${app_name}-${version}$(echo "$url" | sed 's/.*\(\.[^.]*\)$/\1/')"
                
                echo "â¬‡ï¸ ä¸‹è½½é€šç”¨ç‰ˆæœ¬: $filename"
                if curl -L --fail --max-time 300 -o "downloads/$filename" "$url" 2>/dev/null; then
                  echo "downloads/$filename" >> asset_files.txt
                  echo "âœ… é€šç”¨ç‰ˆæœ¬ä¸‹è½½æˆåŠŸ"
                else
                  echo "âŒ é€šç”¨ç‰ˆæœ¬ä¸‹è½½å¤±è´¥"
                fi
              fi
            fi
          }
          
          # åˆå§‹åŒ–èµ„äº§æ–‡ä»¶åˆ—è¡¨
          > asset_files.txt
          
          # ä¸‹è½½æ‰€æœ‰åº”ç”¨ç¨‹åº
          for cask_file in Casks/*.rb; do
            if [[ -f "$cask_file" ]]; then
              download_app_from_cask "$cask_file" || true
            fi
          done
          
          # ç»Ÿè®¡ä¸‹è½½ç»“æœ
          ASSET_COUNT=$(wc -l < asset_files.txt || echo "0")
          echo "asset_count=$ASSET_COUNT" >> $GITHUB_OUTPUT
          echo "ğŸ“Š æˆåŠŸä¸‹è½½ $ASSET_COUNT ä¸ªåº”ç”¨ç¨‹åºæ–‡ä»¶"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create release
        if: steps.check_release.outputs.exists == 'false' || steps.check_release.outputs.should_recreate == 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          PRERELEASE="${{ github.event.inputs.prerelease || 'false' }}"
          
          echo "ğŸš€ åˆ›å»º GitHub Release: $VERSION"
          
          # åˆ›å»º release
          RELEASE_ARGS="--title \"ğŸº Homebrew Proxy Tap $VERSION\" --notes-file release_notes.md"
          
          if [ "$PRERELEASE" = "true" ]; then
            RELEASE_ARGS="$RELEASE_ARGS --prerelease"
            echo "ğŸ“‹ åˆ›å»ºé¢„å‘å¸ƒç‰ˆæœ¬"
          else
            RELEASE_ARGS="$RELEASE_ARGS --latest"
            echo "ğŸ“‹ åˆ›å»ºæ­£å¼å‘å¸ƒç‰ˆæœ¬"
          fi
          
          # å‡†å¤‡èµ„äº§æ–‡ä»¶å‚æ•°
          ASSET_FILES=""
          if [[ -f "asset_files.txt" && -s "asset_files.txt" ]]; then
            while IFS= read -r file; do
              if [[ -f "$file" ]]; then
                ASSET_FILES="$ASSET_FILES \"$file\""
              fi
            done < asset_files.txt
          fi
          
          # åˆ›å»º Release
          if [[ -n "$ASSET_FILES" ]]; then
            eval "gh release create \"$VERSION\" $RELEASE_ARGS $ASSET_FILES"
            echo "âœ… Release åˆ›å»ºæˆåŠŸï¼ŒåŒ…å« ${{ steps.assets.outputs.asset_count }} ä¸ªåº”ç”¨ç¨‹åºæ–‡ä»¶"
          else
            eval "gh release create \"$VERSION\" $RELEASE_ARGS"
            echo "âœ… Release åˆ›å»ºæˆåŠŸï¼ˆæ— åº”ç”¨ç¨‹åºæ–‡ä»¶ï¼‰"
          fi
          
          echo "âœ… Release $VERSION åˆ›å»ºæˆåŠŸï¼"
          echo "ğŸ”— æŸ¥çœ‹åœ°å€: https://github.com/${{ github.repository }}/releases/tag/$VERSION"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Skip release creation
        if: steps.check_release.outputs.exists == 'true' && steps.check_release.outputs.should_recreate == 'false'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "â­ï¸  è·³è¿‡åˆ›å»º Releaseï¼Œå› ä¸º $VERSION å·²å­˜åœ¨"
          echo "ğŸ’¡ æç¤º: å¦‚éœ€é‡æ–°åˆ›å»ºï¼Œè¯·ä½¿ç”¨ 'force_recreate' é€‰é¡¹"
          echo "ğŸ”— ç°æœ‰ Release åœ°å€: https://github.com/${{ github.repository }}/releases/tag/$VERSION"
      
      - name: Cleanup
        if: always()
        run: |
          echo "ğŸ§¹ æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          rm -f app_table.txt install_commands.txt release_notes.md asset_files.txt
          rm -rf downloads/
          echo "âœ… æ¸…ç†å®Œæˆ"
      
      - name: Summary
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          APP_COUNT="${{ steps.apps.outputs.app_count }}"
          
          echo "## ğŸ“‹ Release åˆ›å»ºæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬å·**: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **åº”ç”¨æ•°é‡**: $APP_COUNT" >> $GITHUB_STEP_SUMMARY
          echo "- **èµ„äº§æ–‡ä»¶**: ${{ steps.assets.outputs.asset_count || '0' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å‘å¸ƒçŠ¶æ€**: ${{ (steps.check_release.outputs.exists == 'false' || steps.check_release.outputs.should_recreate == 'true') && 'âœ… å·²åˆ›å»º' || 'â­ï¸ å·²è·³è¿‡ï¼ˆå·²å­˜åœ¨ï¼‰' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **å‘å¸ƒåœ°å€**: [æŸ¥çœ‹ Release](https://github.com/${{ github.repository }}/releases/tag/$VERSION)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸš€ å¿«é€Ÿå®‰è£…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo 'brew tap gandli/proxy' >> $GITHUB_STEP_SUMMARY
          echo 'brew install --cask <app_name>' >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY